<properties
   pageTitle="Azure SQL 데이터베이스에서 쿼리 저장소 운영"
   description="Azure SQL 데이터베이스에서 쿼리 저장소를 운영하는 방법 알아보기"
   keywords=""
   services="sql-database"
   documentationCenter=""
   authors="carlrabeler"
   manager="jhubbard"
   editor=""/>

<tags
   ms.service="sql-database"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="sqldb-performance"
   ms.workload="data-management"
   ms.date="05/25/2016"
   ms.author="carlrab"/>

# Azure SQL 데이터베이스에서 쿼리 저장소 운영 

Azure의 쿼리 저장소는 모든 쿼리에 대한 자세한 기록 정보를 지속적으로 수집하고 제공하는, 완전히 관리되는 데이터베이스 기능입니다. 쿼리 저장소는 비행기의 블랙박스와 비슷하게 생각할 수 있으며, 클라우드와 온-프레미스 고객의 쿼리 성능 문제 해결을 상당히 간소화합니다. 이 문서는 Azure의 쿼리 저장소 운영에 대한 구체적인 측면을 설명합니다. 미리 수집된 쿼리 데이터를 사용하면, 성능 문제를 신속하게 진단하고 해결할 수 있기 때문에 업무에 더 많은 시간을 집중할 수 있습니다.

쿼리 저장소는 2015년 11월부터 Azure SQL 데이터베이스에서 [전세계적으로 사용할 수 있습니다](https://azure.microsoft.com/updates/general-availability-azure-sql-database-query-store/). 쿼리 저장소는 [SQL 데이터베이스 관리자 및 성능 대시보드](https://azure.microsoft.com/updates/sqldatabaseadvisorga/) 같은 성능 분석 및 기능 조정을 위한 기반입니다. 이 문서를 게시하는 순간에도, 200,000개가 넘는 Azure의 사용자 데이터베이스에서 쿼리 저장소가 실행 중이며, 쿼리 관련 정보를 몇 달 동안 중단 없이 수집하고 있습니다.

> [AZURE.IMPORTANT] Microsoft는 모든 Azure SQL 데이터베이스(기존 및 신규)에 대해 쿼리 저장소를 활성화하는 과정에 있습니다. 현재 이러한 활성화 과정에는 단일 데이터베이스만 포함되지만, 가까운 미래에 탄력적 풀 데이터베이스로 확장될 예정입니다. 탄력적 풀을 사용하는 경우, 데이터베이스의 작은 하위 집합에 대해서만 쿼리 저장소를 활성화합니다. 탄력적 풀의 모든 데이터베이스에 대해 쿼리 저장소를 활성화하면, 리소스 사용량이 과도해지고 시스템이 응답하지 않는 상태가 될 수 있습니다.

## Azure SQL 데이터베이스의 관리되는 기능으로서의 쿼리 저장소

쿼리 저장소는 다음 두 가지 기본 원칙을 기반으로 Azure SQL 데이터베이스에서 운영됩니다.

- 고객 워크로드에 가시적인 영향을 유발하지 않습니다.
- 고객 워크로드에 영향을 주지 않는 한, 지속적으로 쿼리를 모니터링합니다.

사용자 워크로드에 대한 영향에는 두 가지 관점이 있습니다.

- ***가용성***: [SQL 데이터베이스에 대한 SLA](https://azure.microsoft.com/support/legal/sla/sql-database/v1_0/)는 쿼리 저장소가 실행될 때 감소되지 않습니다.
- ***성능***: 쿼리 저장소에 의해 발생하는 평균 오버헤드의 일반적인 범위는 1~2%입니다.

Azure의 쿼리 저장소는 제한된 리소스(CPU, 메모리, 디스크 I/O, 디스크 크기 등)를 사용하여 운영됩니다. 정규 워크로드에 대한 영향을 최소화하기 위해서 다양한 시스템 제한 사항을 준수합니다.

- ***정적 제한 사항:*** 지정된 서비스 계층(기본, 표준, 프리미엄, 탄력적 풀)의 리소스 용량에 따라 적용되는 제한 사항.
- ***동적 제한 사항:*** 현재 워크로드 사용(예: 가능한 리소스)에 따라 적용되는 제한 사항.

지속적이고 안정적인 운영을 보장하기 위하여, Azure SQL 데이터베이스는 모든 데이터베이스로부터 주요 운영 데이터를 수집하는 쿼리 저장소 주변에 영구 모니터링 인프라를 구축했습니다. 결과적으로, 안정성을 보장하기 위해 몇 가지 기술 KPI를 계속 모니터링하고 있습니다.

- 예외 및 자동 완화의 수
- READ\_ONLY 상태인 데이터베이스의 수 및 READ\_ONLY 상태의 기간
- 쿼리 저장소 메모리 사용량이 제한을 초과하는 상위 데이터베이스
- 자동 정리 빈도 및 기간별 상위 데이터베이스
- 메모리에 데이터를 로드하는 기간별 상위 데이터베이스(쿼리 저장소 초기화)
- 디스크에 데이터를 플러시하는 기간별 상위 데이터베이스

Azure SQL 데이터베이스는 수집된 데이터를 사용하여:

- ***다수의 데이터베이스에 대한 사용 패턴을 파악하여 기능 안정성과 품질을 개선합니다.*** 쿼리 저장소는 Azure SQL 데이터베이스가 업데이트될 때마다 개선됩니다. 
- ***쿼리 저장소에 의해 유발되는 문제를 해결하거나 완화합니다.*** Azure SQL 데이터베이스는 고객 워크로드에 상당한 영향을 미치는 문제를 감지하고 짧은 대기 시간(한 시간 미만) 내에 완화시킬 수 있습니다. 쿼리 저장소를 일시적으로 ***OFF***로 설정하고 문제를 처리하는 것이 가장 일반적입니다.

때때로, 쿼리 저장소 업데이트는 내부 및 드물게 외부(고객이 보는) 구성에 적용되는 기본 설정을 변경합니다. 결과적으로 Azure SQL 데이터베이스의 쿼리 저장소 사용자 환경은 Azure 플랫폼에 의해 수행되는 자동 작업으로 인해 온-프레미스 환경마다 다를 수 있습니다.

- 쿼리 저장소 상태는 문제를 완화시키기 위해 ***OFF***로 변경했다가 문제가 해결되면 ***ON***으로 되돌릴 수 있습니다.
- 쿼리 저장소 구성은 안정적인 작업을 보장하기 위해 변경될 수 있습니다. 이것은 다음과 같이 수행될 수 있습니다.
    - 불안정하거나 신뢰할 수 없는 문제를 처리하는 개별 데이터베이스 변경.
    - 쿼리 저장소를 사용하는 모든 데이터베이스에 혜택을 제공하는 최적의 구성 변화를 전역적으로 롤아웃.

쿼리 저장소를 ***OFF***로 설정하는 것은 개별 데이터베이스를 범위로 하는 자동 작업입니다. 사용자 데이터베이스에 부정적인 영향을 미치는 제품 동작이 있는 경우에 발생하며, 이에 대해 감지 메커니즘이 경고를 발생시킵니다. 해당 데이터베이스에 대해, 쿼리 저장소는 향상된 쿼리 저장소 구현을 포함하는 새 버전을 사용할 수 있을 때까지 ***OFF*** 상태로 유지됩니다. ***OFF*** 상태로의 전환이 발생하면, 전자 메일을 통해 고객에게 알리고, 새 버전이 출시될 때까지 쿼리 저장소를 다시 활성화하지 않도록 안내합니다. 새 버전이 출시되면, Azure SQL 데이터베이스 인프라는 ***OFF***로 설정되어 있던 모든 데이터베이스에 대해 쿼리 저장소를 자동으로 활성화합니다.

드물지만, Azure SQL 데이터베이스에서 모든 사용자 데이터베이스에 안정적인 작업 및 지속적인 데이터 수집을 위해 최적화된 새로운 구성 기본값을 적용할 수 있습니다.

## 최적인 쿼리 저장소 구성

이 섹션은 쿼리 저장소는 물론 [SQL 데이터베이스 관리자 및 성능 대시보드](https://azure.microsoft.com/updates/sqldatabaseadvisorga/) 등과 같은 종속적인 기능의 안정적인 운영을 보장하기 위해 설계된 최적의 구성 기본값을 설명합니다. 기본 구성은 지속적인 데이터 수집을 위해 최적화됩니다(예: OFF/READ\_ONLY 상태에 소요되는 시간 최소화).

| 구성 | 설명 | 기본값 | 주석 |
| ------------- | ----------- | ------- | ------- |
| MAX\_STORAGE\_SIZE\_MB | 쿼리 저장소가 사용자 데이터베이스 내부에서 사용하는 데이터 공간에 대한 제한을 지정합니다. | 100 | 새 데이터베이스에 적용 |
| INTERVAL\_LENGTH\_MINUTES | 쿼리 계획에 대해 수집된 런타임 통계가 집계되고 지속되는 기간의 규모를 정의합니다. 모든 활성 쿼리 계획은 이 구성을 통해 정의된 기간에 대해 최대 하나의 행을 갖습니다. | 60 | 새 데이터베이스에 적용 |
| STALE\_QUERY\_THRESHOLD\_DAYS | 지속되는 런타임 통계 및 비활성 쿼리의 보존 기간을 제어하는 시간 기반 정리 정책 | 30 | 새 데이터베이스 및 이전 기본값을 포함하는 데이터베이스에 적용(367) |
| SIZE\_BASED\_CLEANUP\_MODE | 쿼리 저장소 데이터 크기가 한도에 접근할 때, 자동 데이터 정리를 수행할지 여부를 지정합니다. | AUTO | 모든 데이터베이스에 적용 |
| QUERY\_CAPTURE\_MODE | 모든 쿼리를 추적할지 또는 쿼리의 하위 집합만 추적할지를 지정합니다. | AUTO | 모든 데이터베이스에 적용 |
| FLUSH\_INTERVAL\_SECONDS | 캡처한 런타임 통계를 디스크에 플러시하기 전에 메모리에 유지하는 최대 기간을 지정합니다. | 900 | 새 데이터베이스에 적용 |
||||||

> [AZURE.IMPORTANT] 이러한 기본값은 모든 Azure SQL 데이터베이스의 쿼리 저장소 활성화 마지막 단계에서 자동으로 적용됩니다(위의 중요 항목 참조). 이후로, Azure SQL 데이터베이스는 고객이 설정한 구성 값이 기본 워크로드 또는 쿼리 저장소의 안정적인 운영에 부정적인 영향을 미치지 않는 한 고객이 설정한 구성 값을 변경하지 않습니다.

사용자 지정 설정을 유지하려는 경우에는, [쿼리 저장소 옵션을 사용하여 ALTER DATABASE](https://msdn.microsoft.com/library/bb522682.aspx)를 사용하여 이전 상태로 구성을 되돌립니다. 최적의 구성 매개 변수를 선택하는 방법을 알아보려면, [쿼리 저장소 모범 사례](https://msdn.microsoft.com/library/mt604821.aspx)를 확인하세요.

## 다음 단계

[SQL 데이터베이스 성능 Insight](sql-database-performance.md)

## 추가 리소스

자세한 내용은 다음 문서를 확인하세요.

- [데이터베이스에 대한 블랙박스](https://azure.microsoft.com/blog/query-store-a-flight-data-recorder-for-your-database) 

- [쿼리 저장소를 사용한 성능 모니터링](https://msdn.microsoft.com/library/dn817826.aspx)

- [쿼리 저장소 사용 시나리오](https://msdn.microsoft.com/library/mt614796.aspx)

- [쿼리 저장소를 사용한 성능 모니터링](https://msdn.microsoft.com/library/dn817826.aspx)

<!---HONumber=AcomDC_0615_2016-->