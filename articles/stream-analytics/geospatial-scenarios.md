---
title: Azure 스트림 분석을 통해 지오펜싱 및 지리 공간 집계
description: 이 문서에서는 지오펜싱 및 지리 공간 집계에 Azure Stream Analytics를 사용하는 방법을 설명합니다.
author: mamccrea
ms.author: mamccrea
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 04/02/2019
ms.openlocfilehash: 5a3aa3786469c3df37b53cb82bdd396871689297
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 03/27/2020
ms.locfileid: "75443633"
---
# <a name="geofencing-and-geospatial-aggregation-scenarios-with-azure-stream-analytics"></a>Azure 스트림 분석을 통해 지오펜싱 및 지리 공간 집계 시나리오

기본 제공 지리 공간 기능을 사용하면 Azure Stream Analytics를 사용하여 차량 관리, 차량 공유, 커넥티드 카 및 자산 추적과 같은 시나리오에 대한 응용 프로그램을 빌드할 수 있습니다.

## <a name="geofencing"></a>지오펜싱

Azure Stream Analytics는 클라우드 및 IoT Edge 런타임에서 낮은 대기 시간 실시간 지오펜싱 계산을 지원합니다.

### <a name="geofencing-scenario"></a>조디펜싱 시나리오

제조 회사는 건물의 자산을 추적해야 합니다. 그들은 GPS와 모든 장치를 갖추고 장치가 특정 영역을 떠날 경우 알림을수신할 수 있습니다.

이 예제에서 사용되는 참조 데이터에는 각 건물에서 허용되는 건물 및 장치에 대한 지오펜스 정보가 있습니다. 참조 데이터는 정적이거나 느린 변경일 수 있습니다. 정적 참조 데이터는 이 시나리오에 사용됩니다. 데이터 스트림은 장치 ID와 현재 위치를 지속적으로 내보합니다.

### <a name="define-geofences-in-reference-data"></a>참조 데이터의 지오펜스 정의

GeoJSON 객체를 사용하여 지오펜스를 정의할 수 있습니다. 호환성 버전 1.2 이상작업의 경우 잘 알려진 텍스트(WKT)를 로 `NVARCHAR(MAX)`사용하여 지오펜스를 정의할 수도 있습니다. WKT는 텍스트 형식으로 공간 데이터를 나타내는 데 사용되는 개방형 지리 공간 컨소시엄(OGC) 표준입니다.

기본 제공 지리 공간 함수는 정의된 지리 울타리를 사용하여 요소가 특정 지오펜스 다각형에 들어있거나 있는지 확인할 수 있습니다.

다음 표는 Azure Blob 저장소 또는 Azure SQL 테이블에 저장할 수 있는 지리 울타리 참조 데이터의 예입니다. 모든 사이트는 지리 공간 다각형으로 표시되며 모든 장치는 허용된 사이트 ID와 연결됩니다.

|사이트 ID|SiteName|지오펜스|허용된장치 ID|
|------|--------|--------|---------------|
|1|"레드먼드 빌딩 41"|"POLYGON(-122.13375792017 47.63782983294432,-122.1337334422777766366366379932573555,-122.13367777 2022530954,-122.13348902897297235 47.637508228080808080667750006 47.6375088080806,12214 47.63732393354484,-122.13265754417773 47.63730947490855,-122.13266290859576 47.637519124743164,-122.13302232460376 47.637515510097955,-122.13301696018573 47.63764925180358,-122.13272728161212 47.63764925180358,-122.13274873928424 47.63784082716388,-122.13373579220172 47.63782998329432))"|"B"|
|2|"레드먼드 빌딩 40"|"POLYGON(-122.13615507967 47.6366745947009,-122.13664544477009,-122.636664444700099,-122.6366610086668836438301506455,-122.1334920666617 9400347675,-122.133497336004 47.63636372927573,-122.13373333 47.63617576323771,-122.13263912671528 47.63616491902258,-122.13264985555134 47.63635649982525,-122.13304682248554 47.636367344000604,-122.13305218690357 47.63650831807564,-122.13276250832996 47.636497473929516,-122.13277323716602 47.63668543881025,-122.1336154507967 47.6366745947009))"|"A"|
|3|"레드먼드 빌딩 22"|"POLYGON(-122.1361660244233 47.6375554,-122.1363526666635266874 47.637483293018,-122.1622383937 3603619712,-122.13622389084293 47.63717699101473,-122.135816996 47.636997778827766 47.637046862778135,-122.13569281345798 47.637144458985965,-122.13570890671207 47.637314348246214,-122.13611660248233 47.63758544698554))"|"C"|

### <a name="generate-alerts-with-geofence"></a>지오펜스로 경고 생성

장치는 라는 스트림을 통해 1분마다 ID와 위치를 내보사할 수 있습니다. `DeviceStreamInput` 다음 표는 입력 스트림입니다.

|DeviceID|지오포지션|
|--------|-----------|
|"A"|"POINT(-122.1329234159497 47.636318374032726)"|
|"B"|"POINT(-122.1333847554553 47.63743531308874)"|
|"C"|"POINT(-122.13354001095752 47.63627622505007)"|

지오펜스 참조 데이터와 장치 스트림을 조인하는 쿼리를 작성하고 장치가 허용된 건물 외부에 있을 때마다 경고를 생성할 수 있습니다.

```SQL
SELECT DeviceStreamInput.DeviceID, SiteReferenceInput.SiteID, SiteReferenceInput.SiteName 
INTO Output
FROM DeviceStreamInput 
JOIN SiteReferenceInput
ON st_within(DeviceStreamInput.GeoPosition, SiteReferenceInput.Geofence) = 0
WHERE DeviceStreamInput.DeviceID = SiteReferenceInput.AllowedDeviceID
```

다음 이미지는 지오펜스를 나타냅니다. 스트림 데이터 입력에 따라 장치가 어디에 있는지 확인할 수 있습니다.

![지오펜스 구축](./media/geospatial-scenarios/building-geofences.png)

장치 "C"는 참조 데이터에 따라 허용되지 않는 건물 ID 2 내부에 있습니다. 이 장치는 건물 ID 3 내부에 있어야 합니다. 이 작업을 실행하면 이 특정 위반에 대한 경고가 생성됩니다.

### <a name="site-with-multiple-allowed-devices"></a>허용되는 장치가 여러 개인 사이트

사이트에서 여러 장치를 허용하는 경우 장치 ID의 배열을 `AllowedDeviceID` 정의할 수 있으며 `WHERE` 절에서 사용자 정의 함수를 사용하여 스트림 장치 ID가 해당 목록의 모든 장치 ID와 일치하는지 확인할 수 있습니다. 자세한 내용은 클라우드 작업에 대한 [Javascript UDF](stream-analytics-javascript-user-defined-functions.md) 자습서및 에지 작업에 대한 [C# UDF](stream-analytics-edge-csharp-udf.md) 자습서를 참조하십시오.

## <a name="geospatial-aggregation"></a>지리 공간 집계

Azure Stream Analytics는 클라우드 및 IoT Edge 런타임에서 짧은 대기 시간 실시간 지리 공간 집계를 지원합니다.

### <a name="geospatial-aggregation-scenario"></a>지리 공간 집계 시나리오

한 택시 회사는 현재 수요가 높은 도시 지역을 향해 승차하고자 하는 택시 운전자를 안내하는 실시간 애플리케이션을 구축하고자 합니다.

이 회사는 도시의 논리적 영역을 참조 데이터로 저장합니다. 각 영역은 RegionID, RegionName 및 지오펜스에 의해 정의됩니다.

### <a name="define-the-geofences"></a>지오펜스 정의

다음 표는 Azure Blob 저장소 또는 Azure SQL 테이블에 저장할 수 있는 지리 울타리 참조 데이터의 예입니다. 모든 영역은 스트리밍 데이터에서 오는 요청과 상관 관계를 지정하는 데 사용되는 지리 공간 다각형으로 표시됩니다.

이러한 다각형은 참고용이며 실제 도시 논리적 또는 물리적 분리를 나타내지 않습니다.

|RegionID|RegionName|지오펜스|
|--------|----------|--------|
|1|"소호"|"폴리곤(-74.04.002795555078275 40.72836252162664,-74.00547745597 9765 40.72192929158663244,-74.00125029839018 40.71893680218 994,-73.995778599998 40.72521409075776,-73.9972377137039 40.725571845884848488898,-74.00279525078275 40.72833625216264) )"|
|2|"차이나타운"|"POLYGON(-73.9971236714876 40.7128858226777133,-73.990101070701236881907936,-73.99023558838384144 33.9897666666966611111111111111111111111111189 40.7155444,-73.99551434573982 40.71733726735,-73.99480629292 40.718491949759304,-73.99652285632942 40.719109951574,-73.99776740131233 40.7168005470334,-73.99903340396736 40.71727219249899,-74.00193018970344 40.71938642421256,-74.00409741458748 40.71688186545551,-74.00051398334358 40.71517415773184,-74.0004281526551 40.714377212470005,-73.99849696216438 40.713450141693166,-73.99748845157478 40.71405192594819,-73.99712367114876 40.71281582267133))"|
|3|"트라이베카"|"POLYGON(-74.0109641815208 40.7258312006777,-74.01338444405054458 40.71466662705,-74.013705155555577777777 117702123415,-74.008620444723533 40.7113081070705777235,-74.0019411120628 40.719423865018 40.72583120006787))"|

### <a name="aggregate-data-over-a-window-of-time"></a>시간 기간 동안 데이터 집계

다음 표에는 "놀이기구"의 스트리밍 데이터가 포함되어 있습니다.

|UserID|에서 위치|ToLocation|트립요청시간|
|------|------------|----------|-----------------|
|"A"|"POINT(-74.00726861389182 40.71610611981975)"|"POINT(-73.986150959917779 40.703107386025835)"|"2019-03-12T07:00:00Z"|
|"B"|"POINT(-74.00249841021645 40.723827238895666)"|"POINT(-74.01160699942085 40.71378884930115)"|"2019-03-12T07:01:00Z"|
|"C"|"POINT(-73.99680120565864 40.71643988624024)"|"POINT(-73.98289663412544 40.72582343999828)"|"2019-03-12T07:02:00Z"|
|"D"|"POINT(-74.00741090068288 40.71615666755086)"|"POINT(-73.97999843120539 40.73477895807408)"|"2019-03-12T07:03:00Z"|

다음 쿼리는 지오펜스 참조 데이터와 장치 스트림을 조인하고 분당 15분의 시간 창에서 지역별 요청 수를 계산합니다.

```SQL
SELECT count(*) as NumberOfRequests, RegionsRefDataInput.RegionName 
FROM UserRequestStreamDataInput
JOIN RegionsRefDataInput 
ON st_within(UserRequestStreamDataInput.FromLocation, RegionsRefDataInput.Geofence) = 1
GROUP BY RegionsRefDataInput.RegionName, hoppingwindow(minute, 1, 15)
```

이 쿼리는 도시 내의 각 지역에서 마지막 15분 동안 매분마다 요청 수를 출력합니다. 이 정보는 Power BI 대시보드를 통해 쉽게 표시되거나 Azure 함수와 같은 서비스와의 통합을 통해 모든 드라이버에 SMS 문자 메시지로 브로드캐스트할 수 있습니다.

아래 이미지는 Power BI 대시보드에 대한 쿼리 출력을 보여 줍니다. 

![전원 BI 대시보드의 결과 출력](./media/geospatial-scenarios/power-bi-output.png)


## <a name="next-steps"></a>다음 단계

* [Stream Analytics 지리 공간적 함수 소개](stream-analytics-geospatial-functions.md)
* [지리 공간 함수(Azure 스트림 분석)](https://docs.microsoft.com/stream-analytics-query/geospatial-functions)
