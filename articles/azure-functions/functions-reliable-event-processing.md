---
title: Azure 함수 신뢰할 수 있는 이벤트 처리
description: Azure 함수에서 이벤트 허브 메시지가 누락되지 않도록 합니다.
author: craigshoemaker
ms.topic: conceptual
ms.date: 09/12/2019
ms.author: cshoe
ms.openlocfilehash: e4f35495d8a01146068cffb9159c29c46c3c0d29
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 03/27/2020
ms.locfileid: "75561870"
---
# <a name="azure-functions-reliable-event-processing"></a>Azure 함수 신뢰할 수 있는 이벤트 처리

이벤트 처리는 서버리스 아키텍처와 관련된 가장 일반적인 시나리오 중 하나입니다. 이 문서에서는 메시지를 잃지 않도록 Azure Functions를 사용하여 신뢰할 수 있는 메시지 프로세서를 만드는 방법을 설명합니다.

## <a name="challenges-of-event-streams-in-distributed-systems"></a>분산 시스템의 이벤트 스트림 문제

초당 100개의 이벤트를 일정한 속도로 전송하는 시스템을 생각해 보십시오. 이 속도로 몇 분 내에 여러 병렬 함수 인스턴스는 초당 들어오는 100개의 이벤트를 사용할 수 있습니다.

그러나 다음과 같은 최적이 아닌 조건은 가능합니다.

- 이벤트 게시자가 손상된 이벤트를 보내는 경우 어떻게 해야 합니까?
- Functions 인스턴스에서 처리되지 않은 예외가 발생하면 어떻게 됩니까?
- 다운스트림 시스템이 오프라인 상태가 되면 어떻게 됩니까?

응용 프로그램의 처리량을 유지하면서 이러한 상황을 어떻게 처리합니까?

대기열에서는 신뢰할 수 있는 메시징이 자연스럽게 제공됩니다. 함수 트리거와 페어링하면 함수가 큐 메시지에 잠금을 만듭니다. 처리가 실패하면 다른 인스턴스가 처리를 다시 시도할 수 있도록 잠금이 해제됩니다. 그런 다음 메시지가 성공적으로 평가되거나 포이즌 큐에 추가될 때까지 처리가 계속됩니다.

단일 큐 메시지가 재시도 주기에 남아 있을 수 있지만 다른 병렬 실행은 계속 남아 있는 메시지의 큐를 제거합니다. 결과적으로 전체 처리량은 하나의 잘못된 메시지의 영향을 크게 받지 않습니다. 그러나 저장소 큐는 순서를 보장하지 않으며 이벤트 허브에 필요한 높은 처리량 요구에 최적화되지 않습니다.

반면 Azure 이벤트 허브에는 잠금 개념이 포함되지 않습니다. 높은 처리량, 여러 소비자 그룹 및 재생 기능과 같은 기능을 허용하기 위해 이벤트 허브 이벤트는 비디오 플레이어처럼 행동합니다. 이벤트는 파티션당 스트림의 단일 지점에서 읽습니다. 포인터에서 해당 위치에서 앞으로 또는 뒤로 읽을 수 있지만 처리할 이벤트에 대한 포인터를 이동하도록 선택해야 합니다.

스트림에서 오류가 발생하면 포인터를 동일한 지점에 유지하려는 경우 포인터가 고급화될 때까지 이벤트 처리가 차단됩니다. 즉, 포인터가 단일 이벤트를 처리하는 문제를 처리하기 위해 중지되면 처리되지 않은 이벤트가 쌓이기 시작합니다.

Azure Functions는 성공 또는 실패에 관계없이 스트림의 포인터를 발전시켜 교착 상태를 방지합니다. 포인터가 계속 발전하기 때문에 함수는 오류를 적절하게 처리해야 합니다.

## <a name="how-azure-functions-consumes-event-hubs-events"></a>Azure 함수가 이벤트 허브 이벤트를 사용하는 방법

Azure 함수는 다음 단계를 순환하는 동안 이벤트 허브 이벤트를 사용합니다.

1. 이벤트 허브의 각 파티션에 대해 Azure Storage에서 포인터가 만들어지고 유지됩니다.
2. 기본적으로 일괄 처리로 새 메시지가 수신되면 호스트는 메시지 일괄 처리로 함수를 트리거하려고 시도합니다.
3. 함수가 실행을 완료하면(예외 유무에 관계없이) 포인터가 진행되고 검사점이 저장소 계정에 저장됩니다.
4. 조건으로 인해 함수 실행이 완료되지 않으면 호스트가 포인터를 진행하지 못합니다. 포인터가 고급되지 않으면 나중에 동일한 메시지를 처리하게 됩니다.
5. 2-4단계 반복

이 동작은 몇 가지 중요한 점을 보여 줍니다.

- *처리되지 않은 예외로 인해 메시지가 손실될 수 있습니다.* 예외가 발생하는 실행은 포인터를 계속 진행합니다.
- *함수는 최소 한 번 배달을 보장합니다.* 코드 및 종속 시스템은 [동일한 메시지를 두 번 받을 수 있다는 사실을 고려해야 할 수](./functions-idempotent.md)있습니다.

## <a name="handling-exceptions"></a>예외 처리

일반적으로 모든 함수에는 최고 수준의 [코드에서 try/catch 블록이](./functions-bindings-error-pages.md) 포함되어야 합니다. 특히 Event Hubs 이벤트를 사용하는 모든 함수에는 블록이 `catch` 있어야 합니다. 이렇게 하면 예외가 발생하면 catch 블록은 포인터가 진행되기 전에 오류를 처리합니다.

### <a name="retry-mechanisms-and-policies"></a>메커니즘 및 정책 다시 시도

일부 예외는 일시적인 특성으로 작동하지만 나중에 작업을 다시 시도할 때 다시 나타나지 않습니다. 이것이 첫 번째 단계가 항상 작업을 다시 시도하는 이유입니다. 다시 시도 처리 규칙을 직접 작성할 수 있지만 매우 평범해서 여러 도구를 사용할 수 있습니다. 이러한 라이브러리를 사용하면 강력한 재시도 정책을 정의할 수 있으므로 처리 순서를 유지하는 데 도움이 될 수 있습니다.

함수에 오류 처리 라이브러리를 도입하면 기본 및 고급 재시도 정책을 모두 정의할 수 있습니다. 예를 들어 다음 규칙에 따라 워크플로를 따르는 정책을 구현할 수 있습니다.

- 메시지를 세 번 삽입해 보십시오(재시도 사이에 지연이 있을 수 있음).
- 모든 재시도의 최종 결과가 실패인 경우 스트림에서 처리를 계속할 수 있도록 큐에 메시지를 추가합니다.
- 손상되거나 처리되지 않은 메시지는 나중에 처리됩니다.

> [!NOTE]
> [Polly](https://github.com/App-vNext/Polly)는 응용 프로그램에 대한 C# 복원력 및 일시적인 오류 처리 라이브러리의 한 가지 예입니다.

미리 준수된 C# 클래스 라이브러리로 작업할 때 [예외 필터를](https://docs.microsoft.com/dotnet/csharp/language-reference/keywords/try-catch) 사용하면 처리되지 않은 예외가 발생할 때마다 코드를 실행할 수 있습니다.

예외 필터를 사용하는 방법을 보여 주는 샘플은 [Azure WebJobs SDK](https://github.com/Azure/azure-webjobs-sdk/wiki) 리포지토리에서 사용할 수 있습니다.

## <a name="non-exception-errors"></a>예외가 아닌 오류

오류가 없는 경우에도 일부 문제가 발생합니다. 예를 들어 실행 중에 발생하는 오류를 고려합니다. 이 경우 함수가 실행을 완료하지 않으면 오프셋 포인터가 진행되지 않습니다. 포인터가 진행되지 않으면 실패한 실행 후에 실행되는 모든 인스턴스가 동일한 메시지를 계속 읽습니다. 이 상황은 "최소 한 번" 보증을 제공합니다.

모든 메시지가 한 번 이상 처리된다는 보장은 일부 메시지가 두 번 이상 처리될 수 있음을 의미합니다. 함수 앱은 이러한 가능성을 알고 있어야 하며 [idempotency 원칙을](./functions-idempotent.md)중심으로 구축되어야 합니다.

## <a name="stop-and-restart-execution"></a>실행 중지 및 다시 시작

몇 가지 오류가 허용될 수 있지만 앱에 심각한 오류가 발생하면 어떻게 해야 합니까? 시스템이 정상 상태에 도달할 때까지 이벤트 트리거링을 중지할 수 있습니다. 회로 차단기 패턴으로 처리를 일시 중지할 수 있는 기회를 갖는 것이 종종 달성됩니다. 회로 차단기 패턴을 사용하면 앱이 이벤트 프로세스의 회로를 "중단"하고 나중에 다시 시작할 수 있습니다.

이벤트 프로세스에서 회로 차단기를 구현하는 데 필요한 두 가지 조각이 있습니다.

- 회로상태를 추적하고 모니터링하기 위해 모든 인스턴스에서 공유 상태
- 회로 상태를 관리할 수 있는 마스터 프로세스(열기 또는 닫힘)

구현 세부 정보는 다를 수 있지만 인스턴스 간에 상태를 공유하려면 저장소 메커니즘이 필요합니다. Azure Storage, Redis 캐시 또는 함수 컬렉션에서 액세스할 수 있는 다른 계정에 상태를 저장하도록 선택할 수 있습니다.

[Azure Logic Apps](../logic-apps/logic-apps-overview.md) 또는 [지속적 엔터티는](./durable/durable-functions-overview.md) 워크플로 및 회로 상태를 관리하는 데 적합합니다. 다른 서비스도 작동할 수 있지만 논리 앱이 이 예제에 사용됩니다. 논리 앱을 사용하면 회로 차단기 패턴을 구현하는 데 필요한 컨트롤을 제공하는 함수의 실행을 일시 중지하고 다시 시작할 수 있습니다.

### <a name="define-a-failure-threshold-across-instances"></a>인스턴스 간 오류 임계값 정의

여러 인스턴스가 동시에 이벤트를 처리하는 것을 고려하려면 회로상태를 모니터링하려면 공유 외부 상태를 유지해야 합니다.

구현하도록 선택할 수 있는 규칙은 다음을 적용할 수 있습니다.

- 모든 인스턴스에서 30초 이내에 100개 이상의 최종 오류가 발생하면 회로를 중단하고 새 메시지에 대한 트리거링을 중지합니다.

구현 세부 정보는 필요에 따라 다르지만 일반적으로 다음과 같은 시스템을 만들 수 있습니다.

1. 저장소 계정에 실패를 기록합니다(Azure 저장소, Redis 등)
1. 새 오류가 기록되면 롤링 수를 검사하여 임계값이 충족되는지 확인합니다(예: 지난 30초 동안 100개 이상).
1. 임계값이 충족되면 Azure 이벤트 그리드에 회로를 중단하라는 이벤트를 내보전합니다.

### <a name="managing-circuit-state-with-azure-logic-apps"></a>Azure 논리 앱으로 회로 상태 관리

다음 설명에서는 Azure Logic 앱을 만들어 함수 앱의 처리를 중지할 수 있는 한 가지 방법을 설명합니다.

Azure Logic Apps에는 다양한 서비스에 대한 기본 제공 커넥터가 함께 제공되며 상태 관리 오케스트레이션을 제공하며 회로 상태를 관리하는 자연스러운 선택입니다. 회로 가 끊어져야 하는 것을 감지한 후 논리 앱을 빌드하여 다음 워크플로를 구현할 수 있습니다.

1. 이벤트 그리드 워크플로를 트리거하고 Azure 리소스 커넥터를 사용 하 고 Azure 함수를 중지 합니다.
1. 워크플로를 다시 시작하는 옵션이 포함된 알림 이메일 보내기

이메일 수신자는 회로의 상태를 조사하고 적절한 경우 알림 전자 메일의 링크를 통해 회로를 다시 시작할 수 있습니다. 워크플로가 함수를 다시 시작하면 마지막 Event Hub 검사점에서 메시지가 처리됩니다.

이 방법을 사용하면 메시지가 손실되지 않고 모든 메시지가 순서대로 처리되며 필요한 만큼 회로를 끊을 수 있습니다.

## <a name="resources"></a>리소스

- [신뢰할 수 있는 이벤트 처리 샘플](https://github.com/jeffhollan/functions-csharp-eventhub-ordered-processing)
- [Azure 내구성 기능 회로 차단기](https://github.com/jeffhollan/functions-durable-actor-circuitbreaker)

## <a name="next-steps"></a>다음 단계

자세한 내용은 다음 자료를 참조하세요.

- [Azure Functions 오류 처리](./functions-bindings-error-pages.md)
- [Event Grid를 사용하여 업로드된 이미지 크기 자동 조정](../event-grid/resize-images-on-storage-blob-upload-event.md?toc=%2Fazure%2Fazure-functions%2Ftoc.json&tabs=dotnet)
- [Azure Logic Apps와 통합되는 함수 만들기](./functions-twitter-email.md)
