<properties 
   pageTitle="부하 분산 장치 사용자 지정 프로브 및 상태 모니터링 | Microsoft Azure"
   description="Azure 부하 분산 장치에 사용자 지정 프로브를 사용하여 부하 분산 장치 뒤의 인스턴스를 모니터링하는 방법을 알아봅니다"
   services="load-balancer"
   documentationCenter="na"
   authors="joaoma"
   manager="carmonm"
   editor=""
   tags="azure-resource-manager"
/>
<tags  
   ms.service="load-balancer"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="01/21/2016"
   ms.author="joaoma" />


# 부하 분산 장치 프로브 

Azure 부하 분산 장치는 프로브를 사용하여 서버 인스턴스의 상태를 모니터링하는 기능을 제공합니다. 프로브가 응답하지 않으면 Azure 부하 분산 장치에서 비정상 인스턴스에 대한 새 연결 전송을 중지합니다. 기존 연결은 영향을 받지 않으며, 새 연결은 정상 인스턴스로 전송됩니다.

부하 분산 장치 뒤의 가상 컴퓨터를 사용하는 경우 TCP 또는 HTTP 사용자 지정 프로브를 구성해야 합니다. 클라우드 서비스 역할(작업자 역할 및 웹 역할)은 게스트 에이전트 프로브 모니터링을 지원하는 유일한 서버 인스턴스입니다.
 
## 프로브 수 및 시간 제한 이해

프로브 동작은 인스턴스를 작동/작동 중지로 표시하는 데 필요한 성공/실패한 프로브 수에 따라 달라집니다. 이는 SuccessFailCount = Timeout / Frequency로 계산됩니다. 포털의 경우 Timeout은 Frequency 값의 두 배로 설정됩니다(Timeout = Frequency * 2).

끝점에 대한 모든 부하 분산된 인스턴스(부하 분산된 집합)의 프로브 구성은 동일해야 합니다. 즉, 특정 끝점 조합에 대해 동일한 호스티드 서비스의 각 역할 인스턴스 또는 가상 컴퓨터에 대한 프로브 구성(예: 로컬 포트, 시간 제한 등)을 다르게 설정할 수 없습니다.


>[AZURE.IMPORTANT] 부하 분산 장치 프로브는 IP 주소 168.63.129.16을 사용합니다. 이 공용 IP 주소는 사용자 IP 가상 네트워크 시나리오에서 내부 플랫폼 리소스에 대한 통신 채널을 용이하게 하는 데 사용됩니다. 가상 공용 IP 주소 168.63.129.16은 모든 지역에서 사용되며, 변경되지 않습니다. 모든 로컬 방화벽 정책에서 이 IP 주소를 허용하는 것이 좋습니다. 내부 Azure 플랫폼에서만 이 주소에서 메시지를 소싱할 수 있으므로 이를 보안 위험으로 간주해서는 안 됩니다. 보안 위험으로 간주하면 168.63.129.16의 동일한 IP 주소 범위를 구성하고 중복된 IP 주소를 사용하는 등 다양한 시나리오에서 예기치 않은 동작이 발생합니다.


## 프로브 유형

### 게스트 에이전트 프로브

클라우드 서비스에만 사용됩니다. Azure 부하 분산 장치는 가상 컴퓨터 내의 게스트 에이전트를 활용하고, 수신 대기하여 인스턴스가 Ready 상태인 경우(즉, 인스턴스가 Busy, Recycling, Stopping 등의 상태가 아닌 경우)에만 HTTP 200 OK 응답으로 응답합니다.

자세한 내용은 [상태 프로브에 대한 서비스 정의 파일(csdef) 구성](https://msdn.microsoft.com/library/azure/jj151530.asp) 또는 [클라우드 서비스를 위한 인터넷 연결 부하 분산 장치 만들기 시작](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services)을 참조하세요.
 
### 게스트 에이전트 프로브에서 인스턴스를 비정상으로 표시하는 경우

게스트 에이전트가 HTTP 200 OK로 응답하지 않으면 Azure 부하 분산 장치에서 인스턴스를 응답하지 않는 것으로 표시하고 해당 인스턴스로 트래픽 전송을 중지합니다. Azure 부하 분산 장치는 계속해서 인스턴스에 ping을 수행하며, 게스트 에이전트가 HTTP 200으로 응답하면 Azure 부하 분산 장치에서 해당 인스턴스로 다시 트래픽을 전송합니다.

웹 역할을 사용하는 경우 웹 사이트 코드는 일반적으로 Azure 패브릭 또는 게스트 에이전트가 모니터링하지 않는 w3wp.exe에서 실행되므로 w3wp.exe의 오류(예: HTTP 500 응답)가 게스트 에이전트에 보고되지 않으며 부하 분산 장치가 해당 인스턴스를 순환에서 제거해야 하는지 알 수 없습니다.


### HTTP 사용자 지정 프로브

사용자 지정 HTTP 부하 분산 장치 프로브는 기본 게스트 에이전트 프로브를 재정의하며, 역할 인스턴스의 상태를 확인하는 고유한 사용자 지정 논리를 만들 수 있게 합니다. 부하 분산 장치는 끝점을 검색하며(기본적으로 15초마다), 시간 제한 기간(기본값 31초) 내에 HTTP 200으로 응답하는 경우 부하 분산 장치가 순환된다고 간주됩니다. 이 기능은 부하 분산 장치 순환에서 인스턴스를 제거하는 사용자 고유의 논리를 구현하는 데 유용할 수 있습니다. 예를 들어 인스턴스가 90% CPU를 초과하면 200이 아닌 상태가 반환됩니다. w3wp.exe를 사용하는 웹 역할의 경우 웹 사이트 코드에 오류가 있으면 부하 분산 장치 프로브에 200이 아닌 상태가 반환되므로 웹 사이트의 자동 모니터링도 사용할 수 있습니다.

>[AZURE.NOTE] HTTP 사용자 지정 프로브는 상대 경로 및 HTTP 프로토콜만 지원합니다. HTTPS는 지원되지 않습니다.


### HTTP 사용자 지정 프로브에서 인스턴스를 비정상으로 표시하는 경우 

- HTTP 응용 프로그램에서 200 이외의 HTTP 응답 코드(예: 403, 404, 500 등)를 반환하는 경우. 이는 응용 프로그램 인스턴스가 서비스에서 즉시 제외하려는 긍정 응답입니다.

-  시간 제한 기간 후 HTTP 서버가 응답하지 않는 경우. 이는 설정된 시간 제한 값에 따라 프로브를 작동 중지(예: SuccessFailCount 프로브가 전송된 경우) 상태로 표시하기 전에 여러 프로브 요청이 응답하지 않음 상태로 전환될 수 있음을 의미합니다.
- 	서버가 TCP 재설정을 통해 연결을 닫은 경우

### TCP 사용자 지정 프로브

TCP 프로브는 정의된 포트에 대해 3방향 핸드셰이크를 수행하여 연결을 시작합니다.

### TCP 사용자 지정 프로브에서 인스턴스를 비정상으로 표시하는 경우

- 시간 제한 기간 후 TCP 서버가 응답하지 않는 경우. 이는 프로브를 작동 중지 상태로 표시하기 전에 응답하지 않음 상태로 전환하도록 구성된 실패한 프로브 요청 수에 따라 달라집니다.
- 	역할 인스턴스에서 TCP 재설정을 받은 경우

HTTP 상태 프로브 또는 TCP 프로브 구성 방법은 [리소스 관리자를 위한 인터넷 연결 부하 분산 장치 만들기 시작](load-balancer-get-started-internet-arm-ps.md#create-lb-rules-nat-rules-a-probe-and-a-load-balancer)을 참조하세요.

## 부하 분산 장치에 다시 정상 인스턴스 추가

TCP 및 HTTP 프로브는 다음과 같은 경우 정상으로 간주되며 역할 인스턴스를 정상 상태로 표시합니다.

- VM이 처음 부팅되고 LB에서 긍정 프로브를 가져온 경우
- SuccessFailCount(위 참조) 숫자가 역할 인스턴스를 정상 상태로 표시하는 데 필요한 성공한 프로브 값을 정의하는 경우. 역할 인스턴스가 제거된 경우 성공한 프로브 행의 SuccessFailCount는 역할 인스턴스를 작동 상태로 표시하는 데 필요합니다.

>[AZURE.NOTE] 역할 인스턴스의 상태가 변동되는 경우 Azure 부하 분산 장치는 역할 인스턴스를 다시 정상 상태로 전환하기 전에 좀 더 오래 기다립니다. 이는 사용자와 인프라를 보호하는 정책을 통해 수행됩니다.

## 부하 분산 장치에 대한 로그 분석

[부하 분산 장치에 대한 로그 분석](load-balancer-monitor-log.md)을 사용하여 프로브 상태 및 프로브 수를 확인할 수 있습니다. Power BI 또는 Operation Insights에서 로깅을 사용하여 부하 분산 장치 상태에 대한 통계를 제공할 수 있습니다.
 

<!---HONumber=AcomDC_0302_2016-->