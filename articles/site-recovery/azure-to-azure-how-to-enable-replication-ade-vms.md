---
title: Azure 사이트 복구에서 암호화된 Azure VM에 대한 복제 를 사용하도록 설정합니다.
description: 이 문서에서는 사이트 복구를 사용하여 한 Azure 지역에서 다른 Azure 디스크 암호화 지원 VM에 대한 복제를 구성하는 방법을 설명합니다.
author: asgang
manager: rochakm
ms.service: site-recovery
ms.topic: article
ms.date: 08/08/2019
ms.author: sutalasi
ms.openlocfilehash: 2bbb02df782439d934e96e7c16f28b9c11cc01fe
ms.sourcegitcommit: b80aafd2c71d7366838811e92bd234ddbab507b6
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 04/16/2020
ms.locfileid: "81408631"
---
# <a name="replicate-azure-disk-encryption-enabled-virtual-machines-to-another-azure-region"></a>Azure 디스크 암호화 가 지원된 가상 컴퓨터를 다른 Azure 지역으로 복제

이 문서에서는 Azure 지역간에 ADE(Azure Disk 암호화)를 사용하도록 설정한 Azure VM을 복제하는 방법을 설명합니다.

>[!NOTE]
> 사이트 복구는 현재 Windows 운영 체제를 실행하는 VM에 대해 AAD(Azure Active Directory)를 사용 및 하지 않고 ADE를 지원합니다. 리눅스 운영 체제의 경우 AAD 없이만 ADE를 지원합니다. 또한 ADE 1.1(AAD 제외)을 실행하는 컴퓨터의 경우 VM이 관리 디스크를 사용해야 합니다. 관리되지 않는 디스크가 있는 VM은 지원되지 않습니다. ADE 0.1(AAD 사용)에서 1.1로 전환하는 경우 1.1을 사용하도록 설정한 후 복제를 비활성화하고 VM에 대한 복제를 사용하도록 설정해야 합니다.


## <a name="required-user-permissions"></a><a id="required-user-permissions"></a>필수 사용자 권한
사이트 복구를 사용하려면 사용자가 대상 영역에서 키 자격 증명 모음을 만들고 소스 지역 키 자격 증명 모음에서 대상 지역 키 자격 증명 모음으로 키를 복사할 수 있는 권한이 있어야 합니다.

Azure 포털에서 디스크 암호화 지원 VM을 복제하려면 사용자는 원본 지역 및 **대상 지역** 키 자격 증명 모음에 대해 다음과 같은 권한이 필요합니다.

- 키 자격 증명 모음 권한
    - 목록, 만들기 및 받기
    
- 키 자격 증명 모음 비밀 권한
    - 비밀 관리 작업
        - 받기, 목록 및 설정
    
- 키 볼트 키 권한(VM이 키 암호화 키를 사용하여 디스크 암호화 키를 암호화하는 경우에만 필요)
    - 주요 관리 운영
        - 받기, 목록 및 만들기
    - 암호화 작업
        - 암호 해독 및 암호화

사용 권한을 관리하려면 포털의 키 자격 증명 모음 리소스로 이동합니다. 사용자에 필요한 권한을 추가합니다. 다음 예제에서는 소스 지역에 있는 키 볼트 *ContosoWeb2Keyvault에*대한 권한을 활성화하는 방법을 보여 주며, 이 권한은 소스 영역에 있습니다.

1. **홈** > 키볼트**ContosoWeb2KeyVault > 액세스 정책으로****이동합니다.** > 

   ![키 자격 증명 모음 권한 창](./media/azure-to-azure-how-to-enable-replication-ade-vms/key-vault-permission-1.png)

2. 사용자 권한이 없음을 확인할 수 있습니다. **새 추가를 선택합니다.** 사용자 및 사용 권한 정보를 입력합니다.

   ![키볼트 권한](./media/azure-to-azure-how-to-enable-replication-ade-vms/key-vault-permission-2.png)

DR(재해 복구)을 사용하도록 설정하는 사용자에게 키를 복사할 권한이 없는 경우 적절한 권한이 있는 보안 관리자는 다음 스크립트를 사용하여 암호화 암호 및 키를 대상 영역에 복사할 수 있습니다.

사용 권한 문제를 해결하려면 이 문서의 후반부에서 [키 자격 증명 모음 권한 문제를](#trusted-root-certificates-error-code-151066) 참조하십시오.

>[!NOTE]
>포털에서 디스크 암호화 지원 VM을 복제하려면 키 자격 증명 모음, 암호 및 키에 대한 최소한 "목록" 권한이 필요합니다.

## <a name="copy-disk-encryption-keys-to-the-dr-region-by-using-the-powershell-script"></a>PowerShell 스크립트를 사용하여 디스크 암호화 키를 DR 영역에 복사합니다.

1. ["복사키" 원시 스크립트 코드를 엽니다.](https://aka.ms/ade-asr-copy-keys-code)
2. 스크립트를 파일에 복사하고 **Copy-keys.ps1의**이름을 지정합니다.
3. Windows PowerShell 응용 프로그램을 열고 파일을 저장한 폴더로 이동합니다.
4. 복사 키를 실행합니다.ps1.
5. 로그인할 Azure 자격 증명을 제공합니다.
6. VM의 **Azure 구독**을 선택합니다.
7. 리소스 그룹이 로드될 때까지 기다린 다음 VM의 **리소스 그룹을** 선택합니다.
8. 표시되는 목록에서 VM을 선택합니다. 디스크 암호화에 사용하도록 설정된 VM만 목록에 있습니다.
9. 대상 **위치를**선택합니다.

    - **디스크 암호화 키 볼트**
    - **키 암호화 키 볼트**

   기본적으로 Site Recovery는 대상 지역에 새 Key Vault를 만듭니다. 볼트 이름에는 원본 VM 디스크 암호화 키를 기반으로 하는 "asr" 접미사가 있습니다. 사이트 복구에서 만든 키 자격 증명 모음이 이미 있으면 다시 사용됩니다. 필요한 경우 목록에서 다른 키 자격 증명 모음을 선택합니다.

## <a name="enable-replication"></a>복제 사용

이 예제에서 기본 Azure 영역은 동아시아이고 보조 영역은 동남 아시아입니다.

1. 볼트에서 **+복제를**선택합니다.
2. 다음 필드를 기록합니다.
    - **원본**: VM의 원점이며 이 경우 **Azure**입니다.
    - **원본 위치**: 가상 컴퓨터를 보호하려는 Azure 지역입니다. 이 예제에서 소스 위치는 "동아시아"입니다.
    - **배포 모델**: 원본 컴퓨터의 Azure 배포 모델입니다.
    - **원본 구독**: 원본 가상 머신이 속한 구독입니다. 복구 서비스 자격 증명 모음과 동일한 Azure Active Directory 테넌트에 있는 모든 구독일 수 있습니다.
    - **리소스 그룹**: 원본 가상 머신이 속해 있는 리소스 그룹입니다. 선택한 리소스 그룹의 모든 VM이 다음 단계에서 보호를 위해 나열됩니다.

3. **가상 컴퓨터** > **에서 가상 컴퓨터를 선택,** 복제할 각 VM을 선택합니다. 복제를 활성화할 수 있는 컴퓨터만 선택할 수 있습니다. 그런 다음 **확인을**선택합니다.

4. **설정에서**다음 대상 사이트 설정을 구성할 수 있습니다.

    - **대상 위치**: 원본 가상 시스템 데이터가 복제되는 위치입니다. 사이트 복구는 선택한 컴퓨터의 위치에 따라 적합한 대상 영역 목록을 제공합니다. 복구 서비스 자격 증명 모음의 위치와 동일한 위치를 사용하는 것이 좋습니다.
    - **대상 구독**: 재해 복구에 사용되는 대상 구독입니다. 기본적으로 대상 구독은 원본 구독과 동일합니다.
    - **대상 리소스 그룹**: 모든 복제된 가상 머신이 속하게 될 리소스 그룹입니다. 기본적으로 사이트 복구는 대상 지역에 새 리소스 그룹을 만듭니다. 이름은 "asr" 접미사를 가져옵니다. Azure 사이트 복구에서 만든 리소스 그룹이 이미 있는 경우 다시 사용됩니다. 다음 섹션과 같이 사용자 지정하도록 선택할 수도 있습니다. 대상 리소스 그룹의 위치는 원본 가상 시스템이 호스팅되는 지역을 제외한 모든 Azure 지역일 수 있습니다.
    - **대상 가상 네트워크**: 기본적으로 사이트 복구는 대상 지역에 새 가상 네트워크를 만듭니다. 이름은 "asr" 접미사를 가져옵니다. 소스 네트워크에 매핑되어 향후 보호에 사용됩니다. [자세히 알아봅니다](site-recovery-network-mapping-azure-to-azure.md) 를 확인해 보세요.
    - **대상 저장소 계정(원본 VM에서 관리 디스크를 사용하지 않는 경우)**: 기본적으로 사이트 복구는 원본 VM 저장소 구성을 모방하여 새 대상 저장소 계정을 만듭니다. 저장소 계정이 이미 있는 경우 다시 사용됩니다.
    - **복제 본원 관리 디스크(원본 VM에서 관리 디스크를 사용하는 경우)**: 사이트 복구는 대상 지역에서 새 복제 본명 관리 디스크를 만들어 원본 VM의 관리 디스크와 동일한 저장소 유형(표준 또는 프리미엄)의 원본 VM 관리 디스크를 미러합니다.
    - **캐시 저장소 계정**: 사이트 복구원본 지역의 *캐시 저장소라는* 추가 저장소 계정이 필요합니다. 원본 VM의 모든 변경 내용을 추적하여 캐시 저장소 계정으로 전송합니다. 그런 다음 대상 위치로 복제됩니다.
    - **가용성 집합**: 기본적으로 사이트 복구는 대상 지역에서 새 가용성 집합을 만듭니다. 이름에는 "asr" 접미사가 있습니다. 사이트 복구에서 만든 가용성 집합이 이미 있으면 다시 사용됩니다.
    - **디스크 암호화 키 자격 증명 모음**: 기본적으로 사이트 복구는 대상 영역에 새 키 자격 증명 모음을 만듭니다. 소스 VM 디스크 암호화 키를 기반으로 하는 "asr" 접미사가 있습니다. Azure 사이트 복구에서 만든 키 자격 증명 모음이 이미 있으면 다시 사용됩니다.
    - **키 암호화 Key Vault**: 기본적으로 Site Recovery는 대상 지역에 새 Key Vault를 만듭니다. 이름에는 소스 VM 키 암호화 키를 기반으로 하는 "asr" 접미사가 있습니다. Azure 사이트 복구에서 만든 키 자격 증명 모음이 이미 있으면 다시 사용됩니다.
    - **복제 정책**: 복구 지점 보존 기록 및 앱 일관된 스냅숏 빈도에 대한 설정을 정의합니다. 기본적으로 사이트 복구는 복구 지점 보존을 위해 *24시간,* 앱 일관된 스냅숏 빈도의 *경우 60분의* 기본 설정으로 새 복제 정책을 만듭니다.

## <a name="customize-target-resources"></a>대상 리소스 사용자 지정

다음 단계에 따라 사이트 복구 기본 대상 설정을 수정합니다.

1. "대상 구독" 옆에서 **사용자 지정을** 선택하여 기본 대상 구독을 수정합니다. Azure AD 테넌트에서 사용할 수 있는 구독 목록에서 구독을 선택합니다.

2. "리소스 그룹, 네트워크, 저장소 및 가용성 집합" 옆에서 **사용자 지정을** 선택하여 다음 기본 설정을 수정합니다.
    - **대상 리소스 그룹의**경우 구독의 대상 위치에 있는 리소스 그룹 목록에서 리소스 그룹을 선택합니다.
    - **대상 가상 네트워크의**경우 대상 위치에 있는 가상 네트워크 목록에서 네트워크를 선택합니다.
    - **가용성 집합의**경우 원본 지역에서 설정된 가용성 집합의 일부인 경우 VM에 가용성 집합 설정을 추가할 수 있습니다.
    - **대상 저장소 계정의**경우 사용할 계정을 선택합니다.

2. "암호화 설정" 옆에서 **사용자 지정을** 선택하여 다음 기본 설정을 수정합니다.
   - **대상 디스크 암호화 키 자격 증명 모음의**경우 구독의 대상 위치에 있는 키 자격 증명 모음 목록에서 대상 디스크 암호화 키 자격 증명 모음을 선택합니다.
   - **대상 키 암호화 키 자격 증명 모음의**경우 구독의 대상 위치에 있는 키 자격 증명 모음 목록에서 대상 키 암호화 키 자격 증명 모음을 선택합니다.

3. **대상 리소스** > **만들기 복제 를 선택합니다.**
4. VM을 복제사용하도록 설정한 후 **복제된 항목**에서 VM의 상태를 확인할 수 있습니다.

>[!NOTE]
>초기 복제 중에 상태가 명백한 진행률 없이 새로 고치는 데 다소 시간이 걸릴 수 있습니다. **새로 고침을** 클릭하여 최신 상태를 가져옵니다.

## <a name="update-target-vm-encryption-settings"></a>대상 VM 암호화 설정 업데이트
다음 시나리오에서는 대상 VM 암호화 설정을 업데이트해야 합니다.
  - VM에서 사이트 복구 복제를 사용하도록 설정했습니다. 나중에 원본 VM에서 디스크 암호화를 사용하도록 설정했습니다.
  - VM에서 사이트 복구 복제를 사용하도록 설정했습니다. 나중에 원본 VM에서 디스크 암호화 키 또는 키 암호화 키를 변경했습니다.

[스크립트를](#copy-disk-encryption-keys-to-the-dr-region-by-using-the-powershell-script) 사용하여 암호화 키를 대상 영역에 복사한 다음 **복구 서비스 볼트** > *복제 항목* > **Properties** > 속성**계산 및 네트워크에서**대상 암호화 설정을 업데이트할 수 있습니다.

![ADE 설정 대화 상자 창 업데이트](./media/azure-to-azure-how-to-enable-replication-ade-vms/update-ade-settings.png)

## <a name="troubleshoot-key-vault-permission-issues-during--azure-to-azure-vm-replication"></a><a id="trusted-root-certificates-error-code-151066"></a>Azure-Azure VM 복제 중 주요 자격 증명 모음 권한 문제 해결

Azure 사이트 복구에는 최소한 소스 지역 키 자격 증명 모음에 대한 읽기 권한이 필요하며 대상 지역 키 자격 증명 모음에 대한 권한을 작성하여 비밀을 읽고 대상 지역 키 자격 증명 모음에 복사해야 합니다. 

**원인 1:** 키를 읽을 수 있는 원본 **지역 키 자격 증명 모음에** "GET" 권한이 없습니다. </br>
**해결 방법:** 구독 관리자여부에 관계없이 키 자격 증명 모음에 대한 권한을 얻는 것이 중요합니다.

1. 이 예제에서 "ContososourceKeyvault" > **액세스 정책인** 소스 지역 키 자격 증명 모음으로 이동 
2. **선택 보안 주체 아래에서** 사용자dradmin@contoso.com이름을 추가합니다.
3. **키 사용 권한 에서 GET을 선택합니다.** 
4. **비밀 권한** 선택 GET 
5. 액세스 정책 저장

**원인 2:** 키를 작성하기 위해 **대상 지역 키 자격 증명 모음에** 대한 권한이 필요하지 않습니다. </br>

*예를 들어*: 소스 지역에 키 볼트 *ContososourceKeyvault가* 있는 VM을 복제하려고 합니다.
원본 지역 키 자격 증명 모음에 대한 모든 권한이 있습니다. 그러나 보호 하는 동안 사용 권한이 없는 이미 만든 키 볼트 ContosotargetKeyvault를 선택 합니다. 오류가 발생합니다.

[대상 키 자격 증명 모음에](#required-user-permissions) 필요한 권한

**해결 방법:** **홈** > **키볼트** > **ContosotargetKeyvault** > 액세스**정책으로** 이동하여 적절한 권한을 추가합니다.

## <a name="next-steps"></a>다음 단계

테스트 장애 조치(failover) 실행에 대해 [자세히 알아보세요](site-recovery-test-failover-to-azure.md).
