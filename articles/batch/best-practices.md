---
title: 모범 사례 - Azure 일괄 처리
description: Azure Batch 솔루션 개발을 위한 모범 사례 및 유용한 팁을 알아봅니다.
author: LauraBrenner
ms.author: labrenne
ms.date: 11/22/2019
ms.service: batch
ms.topic: article
manager: evansma
ms.openlocfilehash: 16fb2786f180b1e28b76d9246d599a871278d00d
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: HT
ms.contentlocale: ko-KR
ms.lasthandoff: 03/27/2020
ms.locfileid: "77022735"
---
# <a name="azure-batch-best-practices"></a>Azure 일괄 처리 모범 사례

이 문서에서는 Azure Batch 서비스를 효과적이고 효율적으로 사용하기 위한 모범 사례 모음에 대해 설명합니다. 이러한 모범 사례는 Batch에 대한 경험과 Batch 고객의 경험에서 비롯됩니다. Batch를 개발하고 사용하는 동안 디자인 함정, 잠재적 성능 문제 및 안티 패턴을 방지하려면 이 문서를 이해하는 것이 중요합니다.

이 문서에서는 다음에 대해 알아봅니다.

> [!div class="checklist"]
> - 모범 사례는 무엇입니까?
> - 모범 사례를 사용해야 하는 이유
> - 모범 사례를 따르지 않을 경우 발생할 수 있습니다.
> - 모범 사례를 따르는 방법

## <a name="pools"></a>풀

일괄 처리 풀은 Batch 서비스에서 작업을 실행하기 위한 계산 리소스입니다. 다음 섹션에서는 Batch 풀로 작업할 때 따라야 할 주요 모범 사례에 대한 지침을 제공합니다.

### <a name="pool-configuration-and-naming"></a>풀 구성 및 이름 지정

- **풀 할당 모드**  
    Batch 계정을 만들 때 두 개의 풀 할당 **모드(일괄 처리 서비스** 또는 **사용자 구독)** 중에서 선택할 수 있습니다. 대부분의 경우 일괄 처리 관리 구독의 백그라운드에서 풀이 할당되는 기본 일괄 처리 서비스 모드를 사용해야 합니다. 대체 사용자 구독 모드인 경우 Batch VM 및 기타 리소스는 풀이 만들어질 때 구독에서 직접 만들어집니다. 사용자 구독 계정은 주로 중요하지만 작은 시나리오 하위 집합을 사용하도록 설정하는 데 사용됩니다. 사용자 구독 모드에 대한 [추가 구성에서 사용자 구독 모드에 대한](batch-account-create-portal.md#additional-configuration-for-user-subscription-mode)자세한 내용을 확인할 수 있습니다.

- **작업 에서 풀 매핑을 결정할 때 작업 및 작업 런닝 시간을 고려합니다.**  
    주로 단기 실행 작업으로 구성된 작업이 있고 예상되는 총 작업 수가 작으면 작업의 전체 예상 실행 시간이 길지 않도록 각 작업에 새 풀을 할당하지 마십시오. 노드의 할당 시간은 작업의 실행 시간을 줄입니다.

- **풀에는 두 개 이상의 계산 노드가 있어야 합니다.**  
    개별 노드가 항상 사용할 수 있다고 보장할 수 있는 것은 아닙니다. 드문 경우지만 하드웨어 오류, 운영 체제 업데이트 및 기타 문제로 인해 개별 노드가 오프라인 상태가 될 수 있습니다. Batch 워크로드에 결정적이고 보장된 진행이 필요한 경우 여러 노드가 있는 풀을 할당해야 합니다.

- **리소스 이름을 다시 사용하지 마십시오.**  
    배치 리소스(작업, 풀 등)는 종종 시간이 지남에 따라 오고 갑니다. 예를 들어 월요일에 풀을 만들고 화요일에 삭제한 다음 목요일에 다른 풀을 만들 수 있습니다. 새로 만드는 각 리소스에는 이전에 사용하지 않은 고유한 이름이 지정되어야 합니다. 이 작업은 GUID(전체 리소스 이름 또는 그 일부로) 또는 리소스 이름에 리소스가 생성된 시간을 포함하여 수행할 수 있습니다. Batch는 실제 리소스 ID가 인간친화적이지 않은 경우에도 리소스에 사람이 읽을 수 있는 이름을 제공하는 데 사용할 수 있는 [DisplayName을](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.jobspecification.displayname?view=azure-dotnet)지원합니다. 고유한 이름을 사용하면 로그 및 메트릭에서 어떤 특정 리소스가 어떤 일을 했는지 쉽게 구분할 수 있습니다. 또한 리소스에 대한 지원 사례를 제출해야 하는 경우 모호성을 제거합니다.

- **풀 유지 관리 및 실패 중 연속성.**  
    작업에서 풀을 동적으로 사용하도록 하는 것이 가장 좋습니다. 작업이 모든 작업에 동일한 풀을 사용하는 경우 풀에 문제가 있으면 작업이 실행되지 않을 수 있습니다. 이는 시간에 민감한 워크로드에 특히 중요합니다. 이 문제를 해결하려면 각 작업을 예약할 때 동적으로 풀을 선택하거나 만들거나 비정상 풀을 우회할 수 있도록 풀 이름을 재정의하는 방법이 있습니다.

- **풀 유지 관리 및 실패 중 비즈니스 연속성**  
    내부 오류, 용량 제약 조건 등과 같이 풀이 원하는 크기로 증가하지 못하게 할 수 있는 여러 가지 원인이 있습니다. 따라서 필요한 경우 다른 풀에서 작업을 리타게팅할 준비가 되어 있어야 합니다(다른 VM 크기 - Batch는 [UpdateJob을](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.protocol.joboperationsextensions.update?view=azure-dotnet)통해 이를 지원합니다). 정적 풀 ID는 삭제되지 않고 변경되지 않을 것이라는 기대를 가지고 사용하지 마십시오.

### <a name="pool-lifetime-and-billing"></a>풀 수명 및 청구

풀 수명은 할당 방법 및 풀 구성에 적용되는 옵션에 따라 달라질 수 있습니다. 풀은 임의수명 수명과 풀의 다양한 수의 계산 노드를 언제든지 가질 수 있습니다. 풀에서 계산 노드를 명시적으로 또는 서비스에서 제공하는 기능(자동 크기 조정 또는 자동 풀)을 통해 관리하는 것은 사용자의 책임입니다.

- **수영장을 신선하게 유지하십시오.**  
    최신 노드 에이전트 업데이트 및 버그 수정을 받으려면 몇 달에 한 번씩 풀 크기를 0으로 조정해야 합니다. 풀은 노드 에이전트 업데이트를 다시 만들거나 0개의 계산 노드로 크기 조정하지 않는 한 노드 에이전트 업데이트를 수신하지 않습니다. 풀을 다시 만들거나 크기를 조정하기 전에 [노드](#nodes) 섹션에서 설명한 대로 디버깅을 위해 노드 에이전트 로그를 다운로드하는 것이 좋습니다.

- **풀 재생성**  
    비슷한 참고로 매일 풀을 삭제하고 다시 만드는 것은 권장되지 않습니다. 대신 새 풀을 만들고 기존 작업을 업데이트하여 새 풀을 가리킵니다. 모든 작업이 새 풀로 이동되면 이전 풀을 삭제합니다.

- **풀 효율성 및 청구**  
    일괄 처리 자체는 추가 요금이 발생하지 않지만 사용된 계산 리소스에 대한 요금이 부과됩니다. 풀의 상태에 관계없이 풀의 모든 계산 노드에 대해 요금이 청구됩니다. 여기에는 노드가 저장소 및 네트워킹 비용과 같이 실행하는 데 필요한 모든 요금이 포함됩니다. 자세한 모범 사례는 [Azure Batch에 대한 비용 분석 및 예산을 참조하세요.](budget.md)

### <a name="pool-allocation-failures"></a>풀 할당 실패

풀 할당 실패는 첫 번째 할당 또는 후속 크기 조정 중에 언제든지 발생할 수 있습니다. 이는 지역의 일시적인 용량 소모 또는 Batch가 사용하는 다른 Azure 서비스의 오류 때문일 수 있습니다. 핵심 할당량은 보장이 아니라 한도입니다.

### <a name="unplanned-downtime"></a>계획되지 않은 가동 중지 시간

일괄 처리 풀에서 Azure에서 가동 중지 시간 이벤트를 경험할 수 있습니다. 이는 Batch에 대한 시나리오 또는 워크플로를 계획하고 개발할 때 염두에 두어야 합니다.

노드가 실패하는 경우 Batch는 사용자를 대신하여 이러한 계산 노드를 자동으로 복구하려고 시도합니다. 이렇게 하면 복구되는 노드에서 실행 중인 작업을 다시 예약할 수 있습니다. 중단된 작업에 대해 자세히 알아보려면 [재시도를 위한 디자인 작업을](#designing-for-retries-and-re-execution) 참조하십시오.

- **Azure 지역 종속성**  
    시간에 민감한 작업 또는 프로덕션 워크로드가 있는 경우 단일 Azure 지역에 의존하지 않는 것이 좋습니다. 드물지만 전체 지역에 영향을 줄 수 있는 문제가 있습니다. 예를 들어 특정 시간에 처리를 시작해야 하는 경우 *시작 시간 전에*기본 리전에서 풀을 확장하는 것이 좋습니다. 해당 풀 확장이 실패하면 백업 지역(또는 지역)에서 풀을 확장하는 것으로 대체될 수 있습니다. 다른 지역의 여러 계정의 풀은 다른 풀에서 문제가 발생하면 쉽게 액세스할 수 있는 백업을 제공합니다. 자세한 내용은 [고가용성을 위해 응용 프로그램 디자인을](high-availability-disaster-recovery.md)참조하십시오.

## <a name="jobs"></a>작업

작업은 수백, 수천 또는 수백만 개의 작업을 포함하도록 설계된 컨테이너입니다.

- **작업에 많은 작업 넣기**  
    작업을 사용하여 단일 작업을 실행하는 것은 비효율적입니다. 예를 들어 각각 10개의 작업을 포함하는 100개의 작업을 만드는 것보다 1000개의 작업을 포함하는 단일 작업을 사용하는 것이 더 효율적입니다. 하나의 작업으로 각각 1000개의 작업을 실행하는 것은 가장 효율적이고 느리며 가장 비용이 많이 드는 접근 방식입니다.  

    수천 개의 활성 작업이 동시에 필요한 Batch 솔루션을 디자인하지 마십시오. 작업에 대한 할당량이 없으므로 가능한 한 적은 작업에서 많은 작업을 실행하면 [작업 및 작업 일정 할당량을](batch-quota-limit.md#resource-quotas)효율적으로 사용합니다.

- **작업 수명**  
    일괄 처리 작업은 시스템에서 삭제될 때까지 무기한 수명이 있습니다. 작업의 상태는 일정을 위해 더 많은 작업을 허용할지 여부를 지정합니다. 명시적으로 종료되지 않는 한 작업이 완료된 상태로 자동으로 이동하지 않습니다. 이 작업은 [onAllTasksComplete](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.common.onalltaskscomplete?view=azure-dotnet) 속성 또는 [maxWallClockTime](https://docs.microsoft.com/rest/api/batchservice/job/add#jobconstraints)을 통해 자동으로 트리거될 수 있습니다.

기본 활성 [작업 및 작업 일정 할당량이](batch-quota-limit.md#resource-quotas)있습니다. 완료된 상태의 작업 및 작업 일정은 이 할당량에 포함되지 않습니다.

## <a name="tasks"></a>작업

작업은 작업을 구성하는 개별 작업 단위입니다. 작업은 사용자가 제출하고 일괄 처리에 의해 예약되어 노드를 계산합니다. 작업을 만들고 실행할 때 고려해야 할 몇 가지 디자인 고려 사항이 있습니다. 다음 섹션에서는 일반적인 시나리오와 문제를 처리하고 효율적으로 수행할 수 있도록 작업을 디자인하는 방법을 설명합니다.

- **작업 데이터를 작업의 일부로 저장합니다.**  
    계산 노드는 본질적으로 일시적입니다. Batch에는 노드가 쉽게 사라질 수 있도록 하는 자동 풀 및 자동 크기 조정과 같은 많은 기능이 있습니다. 노드가 풀을 떠날 때(크기 조정 또는 풀 삭제로 인해) 해당 노드의 모든 파일도 삭제됩니다. 따라서 작업이 완료되기 전에 실행 중인 노드에서 출력을 이동하여 지속 가능한 저장소로 이동하는 것이 좋습니다. Batch는 [OutputFiles를](batch-task-output-files.md)통해 데이터를 업로드하는 Azure Storage를 통합했으며 다양한 공유 파일 시스템을 제공하거나 작업에서 직접 업로드를 수행할 수 있습니다.

### <a name="task-lifetime"></a>작업 수명

- **작업이 완료되면 작업을 삭제합니다.**  
    더 이상 필요하지 않은 경우 작업을 삭제하거나 [retentionTime](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskconstraints.retentiontime?view=azure-dotnet) 작업 제약 조건을 설정합니다. a를 `retentionTime` 설정하면 Batch는 `retentionTime` 만료될 때 작업에 사용되는 디스크 공간을 자동으로 정리합니다.  

    작업을 삭제하려면 두 가지 작업이 수행됩니다. 완료된 작업을 필터링해야 하기 때문에 작업에 작업이 빌드되지 않으므로 관심 있는 작업을 더 어렵게 쿼리/찾는 작업이 없습니다. 또한 노드에서 해당 작업 데이터를 정리합니다(제공된 `retentionTime` 경우 아직 적중되지 않음). 이렇게 하면 노드가 작업 데이터로 채워지지 않고 디스크 공간이 부족해지지 않습니다.

### <a name="task-submission"></a>작업 제출

- **컬렉션에 많은 수의 작업을 제출합니다.**  
    작업은 개별 또는 컬렉션으로 제출할 수 있습니다. 오버헤드 및 제출 시간을 줄이기 위해 작업을 대량으로 제출할 때 한 번에 최대 100개의 [컬렉션에](https://docs.microsoft.com/rest/api/batchservice/task/addcollection) 작업을 제출합니다.

### <a name="task-execution"></a>작업 실행

- **노드당 최대 작업 선택**  
    일괄 처리는 노드에 대한 초과 구독 작업을 지원합니다(노드에 코어가 있는 것보다 많은 작업을 실행). 작업이 풀의 노드에 "적합"하도록 하는 것은 사용자의 선택입니다. 예를 들어, 각각 25%의 CPU 사용량을 하나의 `maxTasksPerNode = 8`노드(풀)에 사용하는 8개의 작업을 예약하려고 하면 성능이 저하될 수 있습니다.

### <a name="designing-for-retries-and-re-execution"></a>재시도 및 재실행을 위한 설계

일괄 처리에서 작업을 자동으로 다시 시도할 수 있습니다. 재시도에는 사용자 제어 및 내부의 두 가지 유형이 있습니다. 사용자 제어 재시도는 작업의 [maxTaskRetryCount에](https://docs.microsoft.com/dotnet/api/microsoft.azure.batch.taskconstraints.maxtaskretrycount?view=azure-dotnet)의해 지정됩니다. 작업에 지정된 프로그램이 0이 아닌 엑시트 코드로 종료되면 작업이 `maxTaskRetryCount`의 값까지 다시 시도됩니다.

드물긴 하지만 작업이 실행되는 동안 내부 상태를 업데이트할 수 없거나 노드에 오류가 발생하는 등 계산 노드의 오류로 인해 내부적으로 작업을 다시 시도할 수 있습니다. 가능하면 동일한 계산 노드에서 작업을 포기하고 다른 계산 노드에서 Batch로 다시 예약할 작업을 연기하기 전에 내부 제한까지 작업이 다시 시도됩니다.

- **내구성 있는 작업 빌드**  
    작업은 오류를 견디고 재시도를 수용하도록 설계되어야 합니다. 이는 장기 실행 작업에 특히 중요합니다. 이렇게 하려면 작업이 두 번 이상 실행되는 경우에도 동일한 단일 결과를 생성해야 합니다. 이를 달성하는 한 가지 방법은 작업을 "목표 추구"로 만드는 것입니다. 또 다른 방법은 작업이 idempotent인지 확인하는 것입니다 (작업은 실행되는 횟수에 관계없이 동일한 결과를 갖습니다).

    일반적인 예는 계산 노드에 파일을 복사하는 작업입니다. 간단한 방법은 실행될 때마다 지정된 모든 파일을 복사하는 작업으로, 이는 비효율적이며 실패를 견딜 수 있도록 빌드되지 않습니다. 대신 파일이 계산 노드에 있는지 확인하는 작업을 만듭니다. 이미 있는 파일을 다시 복사하지 않는 작업입니다. 이러한 방식으로 작업이 중단된 경우 중단된 위치를 선택합니다.

- **우선 순위가 낮은 노드**  
    전용 또는 우선 순위가 낮은 노드에서 작업을 수행할 때 디자인 차이는 없습니다. 우선 순위가 낮은 노드에서 실행되는 동안 작업을 선점하거나 전용 노드의 오류로 인해 중단되는지 여부에 관계없이 오류를 견딜 수 있도록 작업을 설계하여 두 상황을 모두 완화합니다.

- **작업 실행 시간**  
    실행 시간이 짧은 작업을 피하십시오. 1~2초 동안만 실행되는 작업은 적합하지 않습니다. 개별 작업에서 상당한 양의 작업을 수행해야 합니다(최소 10초, 최대 시간 또는 며칠). 각 작업이 1분 이상 실행되는 경우 전체 계산 시간의 일부로 예약 오버헤드가 작습니다.

## <a name="nodes"></a>노드

- **시작 작업은 idempotent이어야합니다.**  
    다른 작업과 마찬가지로 노드 시작 작업은 노드가 부팅될 때마다 다시 실행되기 때문에 idempotent여야 합니다. idempotent 작업은 단순히 여러 번 실행할 때 일관된 결과를 생성하는 작업입니다.

- **운영 체제 서비스 인터페이스를 통해 장기 실행 서비스를 관리합니다.**  
    경우에 따라 노드의 Batch 에이전트와 함께 다른 에이전트를 실행하여 노드에서 데이터를 수집하고 보고해야 하는 경우가 있습니다. 이러한 에이전트는 Windows 서비스 또는 Linux `systemd` 서비스와 같은 OS 서비스로 배포하는 것이 좋습니다.  

    이러한 서비스를 실행할 때 는 파일 잠금으로 인해 Batch가 해당 디렉터리를 삭제할 수 없으므로 노드의 Batch 관리 디렉터리에서 파일 잠금을 수행해서는 안 됩니다. 예를 들어 시작 작업에서 Windows 서비스를 설치하는 대신 시작 작업 디렉터리에서 직접 서비스를 시작하는 대신 다른 곳에서 파일을 복사합니다(파일이 있는 경우 복사본을 건너뛰기만 하면). 해당 위치에서 서비스를 설치합니다. Batch가 시작 작업을 다시 실행하면 시작 작업 디렉터리에서 작업하는 디렉터리가 삭제되고 다시 만듭니다. 이 서비스는 시작 작업 디렉터리가 아닌 다른 디렉터리에 파일 잠금이 있기 때문에 작동합니다.

- **Windows에서 디렉터리 접합을 만들지 마십시오.**  
    디렉터리 하드 링크라고도 하는 디렉터리 접합은 작업 및 작업 정리 중에 처리하기가 어렵습니다. 하드 링크 대신 심볼링크(소프트 링크)를 사용합니다.

- **문제가 있는 경우 일괄 처리 에이전트 로그 수집**  
    노드 또는 노드에서 실행 중인 작업의 동작과 관련된 문제가 발견되면 해당 노드를 할당하기 전에 Batch 에이전트 로그를 수집하는 것이 좋습니다. 일괄 처리 에이전트 로그는 업로드 일괄 처리 서비스 로그 API를 사용하여 수집할 수 있습니다. 이러한 로그는 Microsoft지원 티켓의 일부로 제공될 수 있으며 문제 해결 및 해결에 도움이 됩니다.

## <a name="security"></a>보안

### <a name="security-isolation"></a>보안 격리

격리를 위해 시나리오에서 작업을 서로 격리해야 하는 경우 별도의 풀에 배치하여 이러한 작업을 격리해야 합니다. 풀은 Batch의 보안 격리 경계이며 기본적으로 두 풀이 표시되지 않거나 서로 통신할 수 없습니다. 격리 수단으로 별도의 Batch 계정을 사용하지 마십시오.

## <a name="moving"></a>이동

### <a name="move-batch-account-across-regions"></a>여러 리전 간에 일괄 처리 계정 이동 

기존 Batch 계정을 한 리전에서 다른 리전으로 이동하려는 다양한 시나리오가 있습니다. 예를 들어 재해 복구 계획의 일부로 다른 지역으로 이동할 수 있습니다.

Azure Batch 계정은 한 리전에서 다른 리전으로 이동할 수 없습니다. 그러나 Azure 리소스 관리자 템플릿을 사용하여 Batch 계정의 기존 구성을 내보낼 수 있습니다.  그런 다음 Batch 계정을 템플릿으로 내보내고 대상 지역과 일치하도록 매개 변수를 수정한 다음 템플릿을 새 지역에 배포하여 다른 리전에서 리소스를 배치할 수 있습니다. 템플릿을 새 지역에 업로드한 후 인증서, 작업 일정 및 응용 프로그램 패키지를 다시 만들어야 합니다. 변경 내용을 커밋하고 Batch 계정의 이동을 완료하려면 원래 Batch 계정 또는 리소스 그룹을 삭제해야 합니다.  

리소스 관리자 및 템플릿에 대한 자세한 내용은 [빠른 시작: Azure 포털을 사용하여 Azure 리소스 관리자 템플릿 만들기 및 배포를](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-quickstart-create-templates-use-the-portal)참조하세요.


