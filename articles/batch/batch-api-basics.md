<properties 
	pageTitle="Azure 배치에 대한 API 기본 사항" 
	description="개발자에게 Azure 일괄 처리 API 및 일괄 처리 서비스를 소개하는 개념" 
	services="batch" 
	documentationCenter=".net" 
	authors="yidingzhou" 
	manager="timlt" 
	editor=""/>

<tags 
	ms.service="batch" 
	ms.devlang="multiple" 
	ms.topic="article" 
	ms.tgt_pltfrm="na" 
	ms.workload="big-compute" 
	ms.date="03/19/2015" 
	ms.author="yidingz"/>

<!--The next line, with one pound sign at the beginning, is the page title-->
# Azure 배치에 대한 API 기본 사항

Azure 배치 서비스는 확장 가능한 분산 계산을 위한 작업 예약 프레임워크를 제공합니다. 이 배치 서비스는 Azure에서 여러 클러스터 및 데이터 센터에 위치한 가상 컴퓨터 집합을 유지 관리합니다. 이 배치 서비스는 요청 시에 또는 이러한 지정된 VM 컬렉션에 대해 특정 시간에 실행되도록 예약된 하나 이상의 프로그램을 실행하여 분산 계산을 수행합니다. 배치 서비스는 리소스 요구 사항, 사양 및 사용자가 제공한 제약 조건에 따라 계산 태스크가 실행되도록 이러한 VM을 관리합니다.

배치 서비스를 사용하면 계산 리소스의 큐 대기, 예약, 할당 및 관리를 위한 코드를 작성할 필요가 없습니다. 이 서비스를 사용하면 기본 플랫폼에서 진행되는 작업 예약 및 리소스 관리의 복잡성에 대해 걱정하지 않고 특정 응용 프로그램에 집중할 수 있습니다. 또한 배치 서비스를 통해 이러한 작업의 위치 뿐 아니라 처리해야 하는 데이터에 대한 액세스도 최적화할 수 있습니다.

다음은 배치 서비스를 사용할 때 가능한 일부 시나리오입니다.

- 계산이 많은 병렬 처리

- 파일의 일별 정리

- 일괄 처리

## <a name="resource"></a>배치 서비스의 리소스

배치 서비스를 사용하는 경우 다음 리소스를 활용할 수 있습니다.

- [계정](#account)

- [태스크용 가상 컴퓨터](#taskvm)

- [풀](#pool)

- [작업 항목](#workitem)

- [작업](#job)

- [Task](#task)

	- [시작 태스크](#starttask)
	
	- [작업 관리자 태스크](#jobmanagertask)

### <a name="account"></a>계정

배치 계정은 배치 서비스 내에서 고유 하게 식별되는 엔터티입니다. 모든 처리는 배치 계정을 통해 수행됩니다. 배치 서비스를 사용하여 작업을 수행할 때 계정의 이름 및 키가 필요합니다. 배치 계정을 만들려면 [Azure 배치 개요][]의 배치 계정 섹션을 참조하세요.


### <a name="taskvm"></a>태스크용 가상 컴퓨터

TVM(태스크용 가상 컴퓨터)은 응용 프로그램의 특정 작업을 전담하는 Azure VM입니다. TVM의 크기에 따라 TVM에 할당되는 CPU 코어 수, 메모리 용량 및 로컬 파일 시스템 크기가 결정됩니다. [Azure용 가상 컴퓨터 및 클라우드 서비스 크기](http://msdn.microsoft.com/library/dn197896.aspx)에 설명된 대로 TVM은 소형, 대형 또는 초대형 가상 컴퓨터일 수 있습니다.

TVM이 실행할 수 있는 프로그램의 종류에는 실행 파일(.exe), 명령 파일(.cmd), 배치 파일(.bat) 및 스크립트 파일이 포함됩니다. 또한 TVM에는 다음과 같은 특성이 있습니다.

- 태스크별로 구분된 파일 시스템 폴더 및 공유 파일 시스템 폴더. 폴더 구조 및 환경 변수는 각 풀 VM에 생성됩니다. 태스크 간에 공유되는 응용 프로그램 및 데이터에 대한 "공유" 폴더와 각 태스크에 대한 폴더를 포함하는 다음 폴더 구조가 생성됩니다.

![][1]

- 태스크별 폴더에 기록되는 Stdout.txt 및 stderr.txt 파일

- 처리를 위한 환경 변수

- 액세스를 제어하도록 구성된 방화벽 설정

>VM 액세스
>
>디버깅 등을 위해 VM에 액세스해야 하는 경우 RDP 파일을 가져온 다음 원격 데스크톱을 통해 VM에 액세스하는 데 사용할 수 있습니다.


### <a name="pool"></a>풀

풀은 응용 프로그램이 실행되는 TVM 컬렉션입니다. 사용자가 풀을 만들 수도 있고, 완료할 작업을 지정한 경우에는 배치 서비스에서 자동으로 풀을 만듭니다. 응용 프로그램의 요구를 충족하는 풀을 만들고 관리할 수 있습니다. 풀은 풀이 생성된 배치 계정을 통해서만 사용할 수 있습니다. 하나의 배치 계정에는 둘 이상의 풀이 있을 수 있습니다.

Azure 배치 풀은 핵심 Azure 계산 플랫폼을 기반으로 하여 빌드됩니다. 배치 풀은 대규모 할당, 응용 프로그램 및 데이터 설치, 데이터 이동, 상태 모니터링 및 VM의 유연한 크기 조정 기능을 제공합니다.

풀에 추가된 모든 TVM에는 고유 이름 및 연결된 IP 주소가 할당됩니다. TVM이 풀에서 제거되면 운영 체제에 대해 수행된 변경 내용, 모든 해당 로컬 파일, 해당 이름 및 해당 IP 주소가 손실됩니다. TVM이 풀에서 제거되면 수명이 끝납니다.

풀에 포함된 TVM 간 통신을 허용하도록 풀을 구성할 수 있습니다. 내부 풀 통신이 필요하면 배치 서비스는 풀의 각 TVM에서 1100보다 큰 포트를 허용합니다. 풀에 있는 각 TVM은 이 포트 범위로 들어오는 연결만 허용하고 풀의 다른 TVM에서 들어오는 연결은 제한하도록 구성됩니다. 응용 프로그램에 TVM 간 통신이 필요하지 않으면 배치 서비스는 풀에 여러 다른 클러스터 또는 데이터 센터에 포함된 많은 수의 TVM을 잠재적으로 할당하여 더 많은 병렬 처리를 가능하게 할 수 있습니다.

풀을 만들 때는 다음과 같은 특성을 지정할 수 있습니다.

- 풀에 포함된 **VM의 크기**
	- VM에서 사용할 응용 프로그램의 특성 및 요구 사항에 따라 적절한 VM 크기를 선택해야 합니다. 일반적으로 VM 크기는 VM에서 한 번에 하나씩 태스크가 실행된다고 가정하여 선택됩니다. 예를 들어 응용 프로그램이 다중 스레드인지 여부 및 필요한 메모리 양에 따라 가장 적합하고 비용 효율적인 VM 크기가 결정됩니다. 여러 태스크를 할당하고 여러 응용 프로그램 인스턴스를 병렬로 실행할 수 있으며, 이 경우 일반적으로 더 큰 VM이 선택됩니다. 아래의 "VM당 최대 태스크"를 참조하세요. 
	- 풀에 포함된 모든 VM의 크기가 같아야 합니다. 다른 시스템 요구 사항 및/또는 다른 부하로 다른 응용 프로그램을 실행하려는 경우 별도의 풀을 만들어야 합니다.
	- A0을 제외하고 모든 클라우드 서비스 VM 크기를 풀에 구성할 수 있습니다.

- VM에서 실행되는 운영 체제 제품군 및 버전
	- 작업자 역할과 마찬가지로, OS 제품군 및 OS 버전을 구성할 수 있습니다.
	- OS 제품군은 OS와 함께 설치되는 .NET 버전도 결정합니다.
	- 작업자 역할과 마찬가지로, OS 버전에 대해 "*"를 사용하는 것이 좋습니다. 그러면 VM이 자동으로 업그레이드되며 새 버전을 사용하는 데 필요한 조정 작업이 없습니다. 특정 OS 버전 선택의 기본 사용 사례는 버전을 업데이트하기 전에 이전 버전과의 호환성 테스트를 수행할 수 있게 하여 응용 프로그램 호환성을 유지하는 것입니다. 유효성이 검사되고 나면 풀의 OS 버전을 업데이트하고 새 OS 이미지를 설치할 수 있습니다. 실행 중인 태스크는 모두 중단되고 다시 큐에 대기됩니다.

- 풀에 사용할 수 있어야 하는 VM 개수 목표

- 풀에 대한 크기 조정 정책 VM 수 외에 각 풀에 대한 자동 크기 조정 수식을 지정할 수도 있습니다. 배치 서비스는 수식을 실행하여 풀과 작업 항목 통계를 기준으로 VM 수를 조정합니다.

- 일정 구성
	- 기본 구성은 풀 VM에서 언제든지 하나의 태스크가 실행되는 것이지만 VM에서 동시에 두 개 이상의 태스크를 실행할 수 있도록 하는 것이 효과적인 시나리오도 있습니다. 한 가지 예는 응용 프로그램이 I/O를 기다려야 하는 경우 VM 사용률을 높이는 것입니다. 두 개 이상의 응용 프로그램을 실행하면 CPU 사용률이 증가합니다. 또 다른 예는 풀의 VM 수를 줄이는 것입니다. 이 경우 큰 참조 데이터 집합에 필요한 데이터 복사본의 양을 줄일 수 있습니다. A1이 응용 프로그램에 적합한 크기인 경우 A4를 선택하고, 각각 하나의 코어를 사용하는 최대 8개의 태스크를 동시에 실행하도록 구성을 설정할 수 있습니다.
	- "VM당 최대 작업" 구성은 병렬로 실행할 수 있는 최대 작업 수를 결정합니다.
	- 배치가 VM을 먼저 채우는지 여부나 태스크가 모든 VM에 분산되는지 여부를 결정하는 "채우기 정책"을 지정할 수도 있습니다.
 
- 풀에 포함된 VM의 통신 상태
 	- 대부분의 시나리오에서는 태스크가 독립적으로 작동하고 다른 태스크와 통신할 필요가 없지만, 태스크가 통신하는 일부 응용 프로그램도 있습니다(예: MPI를 사용하는 응용 프로그램).
	- VM이 통신할 수 있는지 여부를 제어하며, 기본 네트워크 인프라를 구성하는 데 사용되고 VM 배치에 영향을 주는 구성이 있습니다.

- 풀에 포함된 TVM의 시작 태스크

풀을 만들 때 풀을 연결해야 하는 저장소 계정을 지정할 수 있습니다. 배치 서비스는 더 나은 네트워크 연결 및 대역폭 용량을 갖는 데이터 센터의 TVM을 지정된 저장소 계정에 할당합니다. 이를 통해 작업 중에 데이터에 보다 효과적으로 액세스할 수 있습니다.

### <a name="workitem"></a>작업 항목

작업 항목은 풀의 TVM에 대해 계산이 수행되는 방식을 지정합니다.

- 작업 항목에는 하나 이상의 작업이 연결될 수 있습니다. 작업 항목에 대해 선택적 일정을 지정할 수 있으며, 이 경우 각 일정 발생마다 하나의 작업이 생성됩니다. 주문형 작업에 대해 일정을 지정하지 않으면 작업이 즉시 생성됩니다.
- 작업 항목은 작업이 실행되는 풀을 지정합니다. 풀은 이미 생성되어 많은 작업 항목에서 사용되는 기존 풀일 수 있지만, 작업 항목과 연결된 각 작업이나 작업 항목과 연결된 모든 작업에 대해 풀을 만들 수도 있습니다.
- 선택적 우선순위를 지정할 수 있습니다. 진행 중인 다른 작업 항목보다 높은 우선 순위로 작업 항목을 제출하면 높은 우선 순위 작업 항목 태스크가 낮은 우선 순위 작업 항목 태스크보다 먼저 큐에 삽입됩니다. 이미 실행 중인 낮은 우선 순위 태스크는 선취되지 않습니다.
- 연결된 작업에 적용할 제약 조건을 지정할 수 있습니다.
	- 작업에 대해 최대 벽시계 시간을 설정할 수 있습니다. 지정된 최대 벽시계 시간보다 오랫동안 작업이 실행되면 작업 및 연결된 모든 태스크가 종료됩니다.
	- Azure 배치는 실패한 태스크를 검색하고 태스크를 다시 시도할 수 있습니다. 태스크가 항상 다시 시도되거나 다시 시도되지 않도록 지정하는 것을 포함하여 태스크 다시 시도의 기본 최대 횟수를 제약 조건으로 지정할 수 있습니다. 태스크 다시 시도는 태스크가 다시 큐에 대기되고 다시 실행되는 것을 의미합니다.
- 작업 항목을 생성한 것과 동일한 방법으로 클라이언트가 작업 항목 작업에 대해 실행할 태스크를 지정할 수 있지만, 작업 관리자 태스크를 지정할 수도 있습니다. 작업 관리자 태스크는 배치 API를 사용하며, 풀 VM 중 하나에서 태스크를 실행하여 작업에 필요한 태스크를 만드는 코드를 포함합니다. 작업 관리자 태스크는 배치에서 특별히 처리되며, 작업이 생성되는 즉시 큐에 대기되고 어떤 이유로든 실패할 경우 다시 시작됩니다. 작업 관리자는 작업이 인스턴스화되기 전에 태스크를 정의할 수 있는 유일한 방법이므로 연결된 일정이 있는 작업 항목에 필요합니다.

### <a name="job"></a>작업

작업은 실행 중인 작업 항목의 인스턴스이며 태스크 컬렉션으로 구성됩니다. 배치 서비스는 작업 항목의 구성에 따라 작업을 인스턴스화합니다. 작업은 작업 항목과 연결된 풀의 TVM을 사용합니다.

### <a name="task"></a>태스크

태스크는 작업과 연결되고 TVM에서 실행되는 계산의 단위입니다. 태스크는 실행을 위해 VM에 할당되거나, VM을 사용할 수 있을 때까지 큐에 대기됩니다. 태스크는 다음 리소스를 사용합니다.

- 작업 항목에 지정된 프로그램

- 처리할 데이터를 포함하는 리소스 파일. 이러한 파일은 Blob 저장소에서 TVM으로 자동으로 복사됩니다. 자세한 내용은 파일 및 디렉터리를 참조하세요.

- 프로그램에 필요한 환경 설정. 자세한 내용은 태스크에 대한 환경 설정을 참조하세요.

- 계산이 수행되어야 하는 제약 조건. 예를 들어 태스크가 실행되도록 할당된 최대 시간, 태스크가 실패한 경우 다시 시도되는 최대 횟수 및 작업 디렉터리에 파일을 보관하는 최대 시간이 여기에 해당합니다.

TVM에서 계산을 수행하도록 정의할 수 있는 태스크 외에도 배치 서비스에서 제공하는 다음과 같은 특수한 태스크를 사용할 수 있습니다.

- [시작 태스크](#starttask)

- [작업 관리자 태스크](#jobmanagertask)

#### <a name="starttask"></a>시작 태스크

시작 태스크를 풀과 연결하여 풀에 포함된 VM의 운영 체제를 구성할 수 있습니다. 소프트웨어 설치 및 백그라운드 프로세스 시작은 시작 태스크가 수행할 수 있는 일부 동작입니다. 시작 태스크는 풀에 남아 있는 한, VM이 시작될 때마다 실행됩니다.

모든 배치 태스크와 마찬가지로, 배치에서 실행되는 명령줄 외에 Azure 저장소의 파일 목록을 지정할 수 있습니다. Azure 배치는 먼저 Azure 저장소에서 파일을 복사한 다음 명령줄을 실행합니다. 풀 시작 태스크의 경우 일반적으로 파일 목록에 응용 프로그램 파일 또는 패키지가 포함되지만, 풀 VM에서 실행되는 모든 태스크에 사용할 참조 데이터가 포함될 수도 있습니다. 예를 들어 명령줄에서 PowerShell 스크립트 또는 robocopy를 수행하여 응용 프로그램 파일을 "공유" 폴더에 복사할 수 있습니다. MSI를 실행할 수도 있습니다.

일반적으로 배치에서 시작 태스크가 완료되기를 기다린 후 VM에 태스크를 할당할 준비가 되었다고 간주하는 것이 좋지만 이는 구성 가능합니다.

풀 VM에 대해 시작 태스크가 실패하면 VM 상태가 실패를 반영하여 업데이트되고 VM에 태스크를 할당할 수 없습니다. 시작 태스크에 대해 지정된 파일을 복사하는 동안 문제가 발생하거나 시작 태스크 프로세스에서 0이 아닌 값을 반환하면 시작 태스크가 실패할 수 있습니다.

VM을 구성하고 응용 프로그램을 설치하는 데 필요한 모든 정보가 선언되면 필요한 새 개수를 지정하는 것만으로 풀의 VM 수를 늘릴 수 있습니다. VM을 구성하고 태스크를 수락하도록 준비하는 데 필요한 모든 정보가 배치에 있습니다.

시작 태스크는 풀 추가 작업의 요청 본문에 JSON 섹션을 추가하여 정의합니다. 다음 예제는 시작 태스크의 기본 정의를 보여 줍니다.

	{
		“commandLine”:”mypoolsetup.exe”,
		“resourceFiles”:
		[
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”mypoolsetup.exe”
			},
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp2.exe”
			}
		],
		“maxTaskRetryCount”:0
	}

C# 인터페이스는 다음과 같이 표시됩니다.

	ICloudPool pool = pm.CreatePool(poolName, targetDedicated: 3, vmSize: "small", osFamily: "3");
	pool.StartTask = new StartTask();
	pool.StartTask.CommandLine = "mypoolsetup.exe";
	pool.StartTask.ResourceFiles = new List<IResourceFile>();
	pool.StartTask.ResourceFiles.Add(new ResourceFile("http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d", "mypoolsetup.exe"));
	pool.Commit();


#### <a name="jobmanagertask"></a>작업 관리자 태스크

작업 관리자 태스크는 다른 모든 작업이 시작되기 전에 시작됩니다. 작업 관리자 태스크는 다음과 같은 이점을 제공합니다.

- 작업이 만들어질 때 배치 서비스가 자동으로 생성합니다.

- 작업의 다른 태스크보다 먼저 진행되도록 예약됩니다.

- 풀 크기를 줄일 경우 연결된 해당 TVM이 풀에서 마지막으로 제거됩니다.

- 다시 시작해야 할 경우 가장 높은 우선 순위가 지정됩니다. 유휴 TVM을 사용할 수 없는 경우 배치 서비스는 풀에서 실행 중인 태스크 중 하나를 종료하여 실행을 위한 공간을 확보할 수 있습니다.

- 해당 종료는 작업의 모든 태스크에 대한 종료에 연결될 수 있습니다.

작업의 작업 관리자 태스크는 다른 작업의 태스크보다 우선 순위가 높지 않습니다. 작업 간에는 작업 수준 우선 순위만 준수됩니다. 작업 관리자 태스크는 작업 항목 추가 작업을 위한 요청 본문에 XML 섹션을 추가하여 정의합니다. 다음 예제는 작업 관리자 태스크의 기본 정의를 보여 줍니다.

	{
		“name”:”jmTask”,
		“commandLine”:”myapp1.exe”,
		“resourceFiles”:
		[
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp1.exe”
			},
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp2.exe”
			}
		],
		“taskConstraints”:
		{
			“maxWallClockTime”:”PT1H”,
			“maxTaskRetryCount”:0,
			“retentionTime”:”PT1H”
		},
		“killJobOnCompletion”:true,
		“runElevated”:false,
		“runExclusive”:true
	}




## <a name="workflow"></a>배치 서비스의 워크플로

배치 서비스를 사용하려면 배치 계정이 필요하고, 서비스의 여러 리소스를 사용하여 계산을 예약합니다. 배치 서비스에서 분산 컴퓨팅 시나리오를 만들 경우 다음과 같은 기본 워크플로를 사용합니다.

1. 분산 컴퓨팅 시나리오에서 사용할 파일을 Azure 저장소 계정에 업로드합니다. 이러한 파일은 배치 서비스에서 액세스할 수 있도록 저장소 계정에 있어야 합니다. 배치 서비스는 해당 파일을 태스크가 실행될 때 TVM에 로드합니다.

2. 저장소 계정에 종속 이진 파일을 업로드합니다. 이진 파일에는 태스크 및 종속 어셈블리에서 실행되는 프로그램이 포함됩니다. 이러한 파일은 저장소에서 액세스할 수는 있어야 하며 TVM에 로드됩니다.

3. TVM 풀을 만듭니다. 풀이 만들어질 때 사용할 태스크용 가상 컴퓨터의 크기를 할당할 수 있습니다. 태스크가 실행될 때 이 풀에서 TVM에 태스크가 할당됩니다.

4. 작업 항목을 만듭니다. 작업 항목을 만들 때 작업이 자동으로 만들어집니다. 작업 항목을 사용하여 태스크 작업을 관리할 수 있습니다.

5. 작업 항목에 태스크를 추가합니다. 각 태스크는 사용자가 업로드한 프로그램을 사용하여 업로드된 파일의 정보를 처리합니다.

6. 출력 결과를 모니터링합니다.

## <a name="files"></a>파일 및 디렉터리

각 태스크에는 태스크에 의해 실행되는 프로그램, 태스크에 의해 처리되는 데이터 및 태스크가 수행한 처리의 출력을 저장하기 위한 0개 이상의 디렉터리 및 파일이 만들어지는 작업 디렉터리가 있습니다. 이러한 디렉터리 및 파일은 한 작업을 실행하는 동안 다른 태스크에서 사용될 수 있습니다. TVM의 모든 작업, 파일 및 디렉터리는 단일 사용자 계정에 의해 소유됩니다.

배치 서비스는 TVM의 파일 시스템 일부를 루트 디렉터리로 노출합니다. TVM의 루트 디렉터리는 WATASK_TVM_ROOT_DIR 환경 변수를 통해 태스크에서 사용될 수 있습니다. 환경 변수 사용에 대한 자세한 내용은 태스크에 대한 환경 설정을 참조하세요.

루트 디렉터리에는 다음과 같은 하위 디렉터리가 포함됩니다.

- **태스크** - 이 위치는 TVM에서 실행되는 태스크에 속하는 모든 파일이 저장되는 위치입니다. 각 태스크에 대해 배치 서비스는 고유 경로의 작업 디렉터리를 %WATASK_TVM_ROOT_DIR%/tasks/workitemName/jobName/taskName/ 형태로 만듭니다. 이 디렉터리는 태스크에 대한 읽기/쓰기 액세스를 제공합니다. 이 디렉터리 아래에서 태스크는 파일을 만들고, 읽고, 업데이트하고, 삭제할 수 있으며 이 디렉터리는 태스크에 대해 지정된 RetentionTime 제약 조건에 따라 유지됩니다.

- **공유** - 이 위치는 계정의 모든 태스크에 대한 공유 디렉터리입니다. TVM에서 공유 디렉터리는 %WATASK_TVM_ROOT_DIR%/shared에 있습니다. 이 디렉터리는 태스크에 대한 읽기/쓰기 액세스를 제공합니다. 태스크는 이 디렉터리 아래에서 파일을 만들고, 읽고, 업데이트하고, 삭제할 수 있습니다.

- **시작** - 이 위치는 시작 태스크에서 작업 디렉터리로 사용됩니다. 시작 태스크를 시작하기 위해 배치 서비스에서 다운로드한 모든 파일도 이 디렉터리 아래에 저장됩니다. TVM에서 시작 디렉터리는 %WATASK_TVM_ROOT_DIR%/start에 있습니다. 태스크는 이 디렉터리 아래에서 파일을 만들고, 읽고, 업데이트하고, 삭제할 수 있으며 이 디렉터리는 시작 태스크가 운영 체제를 구성하는 데 사용할 수 있습니다.

풀에서 TVM이 제거되면 TVM에 저장된 모든 파일이 제거됩니다.

## <a name="lifetime"></a>풀 및 VM 수명

기본적인 디자인 결정은 풀을 만드는 시기 및 VM을 사용 가능한 상태로 유지하는 기간입니다.

하나의 극단적인 예로, 작업이 제출될 때 각 작업에 대해 풀을 만들고 태스크 실행이 완료되면 VM을 제거할 수 있습니다. 이 경우 VM이 반드시 필요할 때만 할당되고 유휴 상태가 되는 즉시 종료되므로 사용률이 극대화됩니다. 작업에서 VM이 할당되기를 기다려야 한다는 의미는 아닙니다. 하지만 VM이 개별적으로 사용 가능하고, 할당되고, 시작 태스크가 완료되는 즉시 VM에 태스크가 예약되는 것에 주의해야 합니다. 즉, 배치는 사용률이 저하되므로 풀의 모든 VM이 사용 가능할 때까지 기다리지 않습니다.

작업 실행을 즉시 시작하는 것이 중요한 경우 풀을 만들어야 하며 작업이 제출되기 전에 VM을 사용할 수 있습니다. 태스크를 즉시 시작할 수 있지만, 부하에 따라 VM이 유휴 상태로 작업 태스크를 기다릴 수 있습니다.

진행 중인 부하량이 가변적인 경우에 대한 한 가지 일반적인 패턴은 여러 작업이 제출되는 하나의 풀을 사용하되 부하에 따라 VM 수를 확장하거나 축소하는 것입니다. 이 작업은 사후 또는 부하를 예측할 수 있는 경우 사전에 수행할 수 있습니다.

## <a name="scaling"></a>응용 프로그램 크기 조정

응용 프로그램은 필요한 계산을 수용하도록 자동으로 쉽게 확장 또는 축소될 수 있습니다. 현재 작업 부하 및 리소스 사용량 통계에 따라 풀의 TVM 수를 동적으로 조정할 수 있습니다. 또한 자동으로 크기가 조정되도록 구성하여 전반적인 응용 프로그램 실행 비용을 최적화할 수 있습니다. 풀이 만들어질 때 크기 조정 설정을 지정할 수 있고 언제든지 구성을 업데이트할 수 있습니다.

VM 수를 줄이는 경우 VM에서 실행 중인 태스크를 고려해야 할 수 있습니다. VM을 즉시 제거하기 위해 실행 중인 태스크를 중지할지 여부나 VM이 제거되기 전에 태스크를 완료할 수 있도록 허용할지 여부를 결정하는 할당 취소 정책을 지정합니다. 작업을 마칠 때 목표 VM 수를 0까지 설정하지만 실행 중인 태스크를 완료할 수 있도록 허용하면 사용률이 극대화됩니다.

일련의 크기 조정 수식을 사용하여 응용 프로그램의 자동 크기 조정을 지정합니다. 다음 크기 조정 간격에 대해 풀에 있는 TVM의 수를 확인하는 데 수식을 사용할 수 있습니다. 예를 들어 풀에서 예약할 많은 수의 태스크를 제출해야 합니다. 보류 중인 작업의 현재 수 및 작업의 완료율에 따라 풀의 크기를 지정하는 크기 조정 수식을 풀에 할당할 수 있습니다. 배치 서비스는 수식을 정기적으로 계산하고 작업에 따라 풀 크기를 조정합니다.

수식은 다음 메트릭을 기반으로 할 수 있습니다.

- **시간 메트릭** - 지정된 시간 동안 5분 간격으로 수집되는 통계를 기반으로 합니다.

- **리소스 메트릭** - CPU 사용량, 대역폭 사용량, 메모리 사용량 및 TVM 수를 기반으로 합니다.

- **태스크 메트릭** - 활성, 보류 중 및 완료됨과 같은 태스크 상태를 기반으로 합니다.

응용 프로그램의 자동 크기 조정에 대한 자세한 내용은 태스크용 가상 컴퓨터의 자동 크기 조정 구성을 참조하세요.

>VM 삭제
>
>자주 필요하지는 않지만, 풀에서 제거할 개별 VM을 지정할 수 있습니다. 예를 들어 신뢰할 수 없는 것으로 의심되는 VM이 있는 경우 제거할 수 있습니다.

## <a name="cert"></a>응용 프로그램 인증서

일반적으로 비밀 정보를 암호화할 때는 인증서를 사용해야 합니다. TVM에 인증서를 설치할 수 있습니다. 암호화된 비밀은 명령줄 매개 변수에서 태스크에 전달되거나 리소스 중 하나에 포함되며 암호를 해독하는 데 설치된 인증서를 사용할 수 있습니다. 비밀 정보의 예로는 저장소 계정에 대한 키가 있습니다.

인증서 추가 작업을 사용하여 배치 계정에 인증서를 추가할 수 있습니다. 그런 다음 인증서를 기존 풀이나 새 풀에 연결할 수 있습니다. 인증서가 풀에 연결되면 배치 서비스가 풀의 각 TVM에 인증서를 설치합니다. 배치 서비스는 TVM이 시작되면 시작 태스크 및 작업 관리자 태스크를 포함하는 태스크를 시작하기 전에 해당 인증서를 설치합니다.

## <a name="scheduling"></a>예약 우선 순위

작업 항목을 만들 때 우선 순위를 할당할 수 있습니다. 작업 항목의 각 작업은 이러한 우선 순위로 만들어집니다. 배치 서비스는 작업의 우선 순위 값을 사용하여 계정 내의 작업 예약 순서를 결정합니다. 우선 순위 값의 범위는-1000에서 1000까지이며 -1000이 가장 낮은 우선 순위를, 1000이 가장 높은 우선 순위를 나타냅니다. 작업 업데이트 작업을 사용하여 작업의 우선 순위를 업데이트할 수 있습니다.

동일한 계정 내에서 우선 순위가 높은 작업은 우선 순위가 낮은 작업보다 먼저 예약됩니다. 하나의 계정에서 우선 순위가 더 높은 작업이 다른 계정에서 우선 순위가 더 낮은 다른 작업보다 먼저 예약되는 것은 아닙니다.

다른 풀의 예약 작업은 서로 별개입니다. 여러 다른 풀이 있을 때 연결된 풀에 유휴 TVM이 부족한 경우 우선 순위가 높은 작업이 먼저 예약된다고 보장할 수 없습니다. 동일한 풀에서는 우선 순위가 같은 작업이 예약될 기회가 동일합니다.

## <a name="environment"></a>태스크에 대한 환경 설정

태스크 컨텍스트에서 사용할 수 있는 환경 설정을 지정할 수 있습니다. 시작 태스크 및 하나의 작업에서 실행되는 태스크에 대한 환경 설정은 태스크 추가 또는 태스크 업데이트 작업의 요청 본문에 XML 섹션을 추가하여 정의합니다.

다음 예제는 환경 설정의 정의를 보여 줍니다.

배치 서비스는 작업에서 예약 된 모든 태스크에 대해 특정 환경 변수 집합을 설정합니다. 다음 표에는 배치 서비스가 모든 태스크에 대해 설정하는 환경 변수가 나와 있습니다.

<table>
  <tr>
   <th>환경 변수 이름
   </th>
   <th>
   설명
   </th>
  </tr>
 <tr>
  <td>
  WATASK_ ACCOUNT_NAME
  </td>
  <td>
  태스크가 속한 계정의 이름
  </td>
 </tr>
 <tr>
  <td>
  WATASK_WORKITEM_NAME
  </td>
  <td >태스크가 속한 작업 항목의 이름
  </td>
 </tr>
 <tr>
  <td>
  WATASK_JOB_NAME
  </td>
  <td >태스크가 속한 작업의 이름
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TASK_NAME
  </td>
  <td >현재 태스크의 이름
  </td>
 </tr>
 <tr>
  <td>
  WATASK_POOL_NAME
  </td>
  <td >태스크가 실행되는 풀의 이름
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TVM_NAME
  </td>
  <td >태스크가 실행되는 TVM의 이름
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TVM_ROOT_DIR
  </td>
  <td >TVM의 루트 디렉터리 전체 경로
  </td>
 </tr>
 <tr>
  <td>
  WATASK_PORTRANGE_LOW WATASK_PORTRANGE_HIGH
</td>
<td>
  내부 풀 통신을 사용되도록 설정된 경우 태스크가 통신에 사용할 수 있는 포트 범위(경계값 포함)입니다.
</td>
</table>

**참고**

이러한 시스템 정의 변수는 덮어쓸 수 없습니다.

태스크 가져오기 작업을 사용하여 환경 설정 값을 검색할 수 있습니다.

## <a name="errorhandling"></a>오류 처리

###태스크 오류 처리
태스크 오류는 다음 범주로 분류됩니다.

- 예약 오류:
	- 태스크에 대해 파일이 지정된 경우 하나 이상의 파일 복사가 실패할 수 있습니다. 이 오류는 파일이 이동되었거나, 저장소 계정을 더 이상 사용할 수 없기 때문일 수 있습니다.
	- 이 경우 태스크에 대해 "예약 오류"가 설정됩니다.
- 응용 프로그램 오류:
	- 명령줄에서 지정된 태스크 프로세스도 실패할 수 있습니다. 0이 아닌 종료 코드가 반환되면 프로세스가 실패한 것으로 간주됩니다.
	- 응용 프로그램 오류의 경우 지정된 횟수까지 자동으로 태스크를 다시 시도하도록 배치를 구성할 수 있습니다. 
- 제약 조건 오류:
	- 작업 또는 태스크를 실행할 수 있는 최대 기간에 대해 제약 조건을 지정할 수 있습니다. 이 기능은 응답이 없는 태스크를 종료하는 데 유용할 수 있습니다.
	- 최대 기간을 초과하면 태스크가 완료된 것으로 표시되지만 종료 코드가 `0xC000013A`로 표시되고 schedulingError 필드가 `{ category:“ServerError”, code=“TaskEnded”}`로 표시됩니다.

###응용 프로그램 오류 디버그

응용 프로그램에서 문제를 해결하는 데 사용할 수 있는 진단을 생성할 수 있습니다. 대체로 응용 프로그램은 stdout 및 stderr 파일에 정보를 쓰거나 사용자 지정 파일에 출력을 씁니다. 이러한 경우 태스크 또는 VM을 지정하여 파일을 가져오기 위한 API가 제공됩니다.

풀 VM에 로그인할 수도 있습니다. API는 VM에 대한 RDP 파일을 반환하며, 이 파일을 사용하여 VM에 로그인할 수 있습니다.

###태스크 오류 및 문제에 대한 조정

몇 가지 이유로 태스크가 실패하거나 중단될 수 있습니다. 태스크 응용 프로그램 자체가 실패하거나, 태스크를 실행 중인 VM이 다시 부팅되거나, 할당 취소 정책이 태스크가 완료되기를 기다리지 않고 즉시 VM을 제거하도록 설정된 상태에서 풀 크기 조정에 의해 VM이 제거되었습니다. 어떤 경우든지 배치가 자동으로 태스크를 다시 큐에 대기할 수 있으며, 다른 VM에서 실행될 수 있습니다.

일시적인 문제로 인해 태스크가 응답하지 않거나 실행하는 데 너무 오래 걸릴 수도 있습니다. 작업에 대해 최대 실행 시간을 설정할 수 있으며, 초과할 경우 배치가 태스크 응용 프로그램을 중단합니다. 현재, 이 경우에서 자동으로 큐에 다시 대기할 수는 없지만 클라이언트가 이러한 경우를 검색하여 새 태스크를 제출할 수 있습니다.

###"잘못된" VM에 대한 조정

풀의 각 VM에는 고유 이름이 지정되며, 태스크가 실행되는 VM이 태스크 메타데이터에 포함됩니다. 어떤 이유로든 태스크가 실패하도록 하는 VM이 있는 경우 클라이언트가 이를 확인할 수 있으며, 의심되는 VM이 풀에서 삭제됩니다. 삭제된 VM에서 태스크를 실행한 경우 자동으로 다시 큐에 대기되고 다른 VM에서 실행됩니다.


<!--Image references-->
[1]: ./media/batch-api-basics/batch-api-basics-01.png

[Azure 배치 개요]: batch-technical-overview.md

<!---HONumber=July15_HO4-->