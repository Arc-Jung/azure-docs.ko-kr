---
title: '자습서: Azure Firewall Manager 미리 보기를 사용하여 허브 가상 네트워크 보호'
description: 이 자습서에서는 Azure Portal에서 Azure Firewall Manager를 사용하여 가상 네트워크를 보호하는 방법을 알아봅니다.
services: firewall-manager
author: vhorne
ms.service: firewall-manager
ms.topic: tutorial
ms.date: 02/18/2020
ms.author: victorh
ms.openlocfilehash: cdd416bdb833e4784334a6847d724a7375e2ef8d
ms.sourcegitcommit: 6ee876c800da7a14464d276cd726a49b504c45c5
ms.translationtype: HT
ms.contentlocale: ko-KR
ms.lasthandoff: 02/19/2020
ms.locfileid: "77459956"
---
# <a name="tutorial-secure-your-hub-virtual-network-using-azure-firewall-manager-preview"></a>자습서: Azure Firewall Manager 미리 보기를 사용하여 허브 가상 네트워크 보호 

[!INCLUDE [Preview](../../includes/firewall-manager-preview-notice.md)]

온-프레미스 네트워크를 Azure Virtual Network에 연결하여 하이브리드 네트워크를 만들 경우 Azure 네트워크 리소스에 대한 액세스를 제어하는 기능은 전체 보안 계획의 중요한 부분입니다.

Azure Firewall Manager 미리 보기를 사용하면 개인 IP 주소, Azure PaaS 및 인터넷으로 향하는 하이브리드 네트워크 트래픽을 보호하는 허브 가상 네트워크를 만들 수 있습니다. Azure Firewall Manager를 사용하여 허용되거나 거부되는 네트워크 트래픽을 정의하는 정책을 사용하여 하이브리드 네트워크에서 네트워크 액세스를 제어할 수 있습니다.

또한 Firewall Manager는 보안 가상 허브 네트워크 아키텍처를 지원합니다. 보안 가상 허브 및 허브 가상 네트워크 아키텍처 유형을 비교하려면 [Azure Firewall Manager 아키텍처 옵션이란?](vhubs-and-vnets.md)을 참조하세요.

이 자습서에서는 다음과 같은 세 가상 네트워크를 만듭니다.

- **VNet-Hub** - 방화벽이 이 가상 네트워크에 있습니다.
- **VNet-Spoke** - 스포크 가상 네트워크는 Azure에 있는 워크로드를 나타냅니다.
- **VNet-Onprem** - 온-프레미스 가상 네트워크는 온-프레미스 네트워크를 나타냅니다. 실제 배포에서는 VPN 또는 ExpressRoute 연결을 통해 연결할 수 있습니다. 간단히 하기 위해 이 자습서에서는 VPN 게이트웨이 연결을 사용하며 Azure에 있는 가상 네트워크를 사용하여 온-프레미스 네트워크를 나타냅니다.

![하이브리드 네트워크](media/tutorial-hybrid-portal/hybrid-network-firewall.png)

이 자습서에서는 다음 작업 방법을 알아봅니다.

> [!div class="checklist"]
> * 방화벽 정책 만들기
> * 가상 네트워크 만들기
> * 방화벽 구성 및 배포
> * VPN 게이트웨이 만들기 및 연결
> * 허브 및 스포크 가상 네트워크 피어링
> * 경로 만들기
> * 가상 머신 만들기
> * 방화벽 테스트


## <a name="prerequisites"></a>사전 요구 사항

하이브리드 네트워크는 허브 및 스포크 아키텍처 모델을 사용하여 Azure VNet과 온-프레미스 네트워크 간에 트래픽을 라우팅합니다. 허브 및 스포크 아키텍처에는 다음과 같은 요구 사항이 있습니다.

- VNet-Hub를 VNet-Spoke로 피어링하는 경우 **AllowGatewayTransit**을 설정합니다. 허브 및 스포크 네트워크 아키텍처에서 스포크 가상 네트워크는 게이트웨이 전송을 통해 모든 스포크 가상 네트워크에서 VPN 게이트웨이를 배포하는 대신 허브에서 VPN 게이트웨이를 공유할 수 있습니다. 

   또한 게이트웨이에 연결된 가상 네트워크 또는 온-프레미스 네트워크에 대한 경로는 게이트웨이 전송을 사용하여 피어링된 가상 네트워크에 대한 라우팅 테이블에 자동으로 전파됩니다. 자세한 내용은 [가상 네트워크 피어링을 위한 VPN 게이트웨이 전송 구성](../vpn-gateway/vpn-gateway-peering-gateway-transit.md)을 참조하세요.

- VNet-Spoke를 VNet-Hub에 피어링할 때 **UseRemoteGateways**를 설정합니다. **UseRemoteGateways**가 설정되고 원격 피어링의 **AllowGatewayTransit**도 설정된 경우, 스포크 가상 네트워크는 전송을 위해 원격 가상 네트워크의 게이트웨이를 사용합니다.
- 허브 방화벽을 통해 스포크 서브넷 트래픽을 라우팅하려면 **가상 네트워크 게이트웨이 경로 전파** 설정을 사용하지 않도록 설정된 방화벽을 가리키는 UDR(사용자 정의 경로)이 필요합니다. 이 옵션은 경로를 스포크 서브넷으로 배포하지 않도록 방지합니다. 이렇게 하면 학습된 경로가 UDR과 충돌하지 않습니다.
- 스포크 네트워크에 대한 다음 홉으로 방화벽 IP 주소를 가리키는 허브 게이트웨이 서브넷에서 UDR을 구성합니다. Azure Firewall 서브넷에서는 BGP로부터 경로를 학습하므로 UDR이 필요하지 않습니다.

이 경로를 만드는 방법은 이 자습서의 [경로 만들기](#create-the-routes) 섹션을 참조하세요.

>[!NOTE]
>Azure Firewall에는 직접 인터넷 연결이 있어야 합니다. AzureFirewallSubnet이 BGP를 통해 온-프레미스 네트워크에 대한 기본 경로를 학습하는 경우 이 경로를 직접 인터넷 연결을 유지하기 위해 **Internet**으로 설정된 **NextHopType** 값을 통해 0.0.0.0/0 UDR로 재정의해야 합니다.
>
>Azure Firewall은 강제 터널링을 지원하도록 구성할 수 있습니다. 자세한 내용은 [Azure Firewall 강제 터널링](../firewall/forced-tunneling.md)을 참조하세요.

>[!NOTE]
>직접 피어링된 VNet 사이의 트래픽은 UDR이 기본 게이트웨이로 Azure Firewall을 가리키는 경우에도 직접 라우팅됩니다. 이 시나리오에서 서브넷 트래픽에 대한 서브넷을 방화벽으로 보내려면 UDR에 두 가지 서브넷에 명시적으로 지정된 대상 서브넷 네트워크 접두사가 포함되어 있어야 합니다.

Azure 구독이 아직 없는 경우 시작하기 전에 [체험 계정](https://azure.microsoft.com/free/?WT.mc_id=A261C142F)을 만듭니다.

## <a name="create-a-firewall-policy"></a>방화벽 정책 만들기

1. [https://portal.azure.com](https://portal.azure.com)에서 Azure Portal에 로그인합니다.
2. Azure Portal 검색 창에서 **Firewall Manager**를 입력하고 **Enter** 키를 누릅니다.
3. Azure Firewall Manager 페이지에서 **Azure Firewall 정책 보기**를 선택합니다.

   ![방화벽 정책](media/tutorial-hybrid-portal/firewall-manager-policy.png)

1. **Azure Firewall 정책 만들기**를 선택합니다.
1. 구독을 선택하고, 리소스 그룹에 대해 **새로 만들기**를 선택하고, **FW-Hybrid-Test**라는 리소스 그룹을 만듭니다.
2. 정책 이름에 대해 **Pol-Net01**을 입력합니다.
3. 지역에 대해 **미국 동부**를 선택합니다.
4. **다음: 규칙**을 선택합니다.
5. **규칙 컬렉션 추가**를 선택합니다.
6. **이름**에 대해 **RCNet01**을 입력합니다.
7. **규칙 컬렉션 형식**에 대해 **네트워크**를 선택합니다.
8. **우선 순위**에 대해 **100**을 입력합니다.
9. **동작**에 대해 **허용**을 선택합니다.
10. **규칙** 아래에서 **이름**에 대해 **AllowWeb**을 입력합니다.
11. **원본 주소**에 대해 **192.168.1.0/24**를 입력합니다.
12. **프로토콜**의 경우 **TCP**를 선택합니다.
13. **대상 포트**에 대해 **80**을 입력합니다.
14. **대상 유형**에 대해 **IP 주소**를 선택합니다.
15. **대상**에 대해 **10.6.0.0/16**을 입력합니다.
16. 다음과 같이 규칙 행에서 해당 정보를 입력합니다.
 
    이름: **AllowRDP** 입력<br>
    원본 IP 주소: **192.168.1.0/24** 입력<br>
    프로토콜: **TCP** 선택<br>
    대상 포트: **3389** 입력<br>
    대상 유형: **IP 주소** 선택<br>
    대상: **10.6.0.0/16** 입력

1. **추가**를 선택합니다.
2. **검토 + 만들기**를 선택합니다.
3. 세부 정보를 검토한 다음, **만들기**를 선택합니다.

## <a name="create-the-firewall-hub-virtual-network"></a>방화벽 허브 가상 네트워크 만들기

> [!NOTE]
> AzureFirewallSubnet 서브넷의 크기는 /26입니다. 서브넷 크기에 대한 자세한 내용은 [Azure Firewall FAQ](../firewall/firewall-faq.md#why-does-azure-firewall-need-a-26-subnet-size)를 참조하세요.

1. Azure Portal 홈 페이지에서 **리소스 만들기**를 선택합니다.
2. **네트워킹** 아래에서 **가상 네트워크**를 선택합니다.
4. **이름**에 대해 **VNet-hub**를 입력합니다.
5. **주소 공간**에 대해 **10.5.0.0/16**을 입력합니다.
6. **구독**의 경우 사용자의 구독을 선택합니다.
7. **리소스 그룹**에 대해 **FW-Hybrid-Test**를 선택합니다.
8. **위치**에 대해 **미국 동부**를 선택합니다.
9. **서브넷** 아래에서 **이름**에 **AzureFirewallSubnet**을 입력합니다. 방화벽은 이 서브넷에 있고 해당 서브넷 이름은 AzureFirewallSubnet이 **되어야** 합니다.
10. **주소 범위**에 대해 **10.5.0.0/26**을 입력합니다. 
11. 다른 기본 설정을 유지한 다음, **만들기**를 선택합니다.

## <a name="create-the-spoke-virtual-network"></a>스포크 가상 네트워크 만들기

1. Azure Portal 홈 페이지에서 **리소스 만들기**를 선택합니다.
2. **네트워킹** 아래에서 **가상 네트워크**를 선택합니다.
4. **이름**에 대해 **VNet-Spoke**를 입력합니다.
5. **주소 공간**에 대해 **10.6.0.0/16**을 입력합니다.
6. **구독**의 경우 사용자의 구독을 선택합니다.
7. **리소스 그룹**에 대해 **FW-Hybrid-Test**를 선택합니다.
8. **위치**의 경우 전에 사용한 동일한 위치를 선택합니다.
9. **서브넷** 아래의 **이름**에 대해 **SN-Workload**를 입력합니다.
10. **주소 범위**에 대해 **10.6.0.0/24**를 입력합니다.
11. 다른 기본 설정을 유지한 다음, **만들기**를 선택합니다.

## <a name="create-the-on-premises-virtual-network"></a>온-프레미스 가상 네트워크 만들기

1. Azure Portal 홈 페이지에서 **리소스 만들기**를 선택합니다.
2. **네트워킹** 아래에서 **가상 네트워크**를 선택합니다.
4. **이름**에 대해 **VNet-OnPrem**을 입력합니다.
5. **주소 공간**에 대해 **192.168.0.0/16**을 입력합니다.
6. **구독**의 경우 사용자의 구독을 선택합니다.
7. **리소스 그룹**에 대해 **FW-Hybrid-Test**를 선택합니다.
8. **위치**의 경우 전에 사용한 동일한 위치를 선택합니다.
9. **서브넷** 아래에서 **이름**에 대해 **SN-Corp**를 입력합니다.
10. **주소 범위**에 대해 **192.168.1.0/24**를 입력합니다.
11. 다른 기본 설정을 유지한 다음, **만들기**를 선택합니다.

가상 네트워크가 배포되면 게이트웨이의 두 번째 서브넷을 만듭니다.

1. **VNet-Onprem** 페이지에서 **서브넷**을 선택합니다.
2. **+서브넷**을 선택합니다.
3. **이름**에 대해 **GatewaySubnet**을 입력합니다.
4. **주소 범위(CIDR 블록)** 에 대해 **192.168.2.0/24**를 입력합니다.
5. **확인**을 선택합니다.

### <a name="create-a-public-ip-address"></a>공용 IP 주소 만들기

온-프레미스 게이트웨이에 사용되는 공용 IP 주소입니다.

1. Azure Portal 홈 페이지에서 **리소스 만들기**를 선택합니다.
2. 검색 텍스트 상자에서 **공용 IP 주소**를 입력하고, **Enter** 키를 누릅니다.
3. **공용 IP 주소**, **만들기**를 차례로 선택합니다.
4. 이름에 대해 **VNet-Onprem-GW-pip**를 입력합니다.
5. 리소스 그룹에 대해 **FW-Hybrid-Test**를 입력합니다.
6. **위치**에 대해 **미국 동부**를 선택합니다.
7. 나머지 항목에 대해 기본값을 적용한 다음, **만들기**를 선택합니다.

## <a name="configure-and-deploy-the-firewall"></a>방화벽 구성 및 배포

보안 정책이 허브와 연결되면 이를 *허브 가상 네트워크*라고 합니다.

**VNet-Hub** 가상 네트워크를 *허브 가상 네트워크*로 변환하고, Azure Firewall을 사용하여 보안을 유지합니다.

1. Azure Portal 검색 창에서 **Firewall Manager**를 입력하고 **Enter** 키를 누릅니다.
3. Azure Firewall Manager 페이지의 **가상 네트워크에 보안 추가** 아래에서 **허브 가상 네트워크 보기**를 선택합니다.
4. **가상 네트워크 변환**을 선택합니다.
5. **VNet-hub**를 선택하고, **다음: Azure Firewall**을 선택합니다.
6. **방화벽 정책**에 대해 **Pol-Net01**을 선택합니다.
7. **다음 " 검토 + 확인**을 선택합니다.
8. 세부 정보를 검토한 다음, **확인**을 선택합니다.


   배포하는 데 몇 분 정도 걸립니다.
7. 배포가 완료되면 **FW-Hybrid-Test** 리소스 그룹으로 이동하여 방화벽을 선택합니다.
9. **개요** 페이지의 **방화벽 개인 IP** 주소를 적어 둡니다. 기본 경로를 만들 때 나중에 사용할 수 있습니다.

## <a name="create-and-connect-the-vpn-gateways"></a>VPN 게이트웨이 만들기 및 연결

허브 및 온-프레미스 가상 네트워크는 VPN Gateway를 통해 연결됩니다.

### <a name="create-a-vpn-gateway-for-the-hub-virtual-network"></a>허브 가상 네트워크에 대한 VPN Gateway 만들기

이제 허브 가상 네트워크에 대한 VPN Gateway를 만듭니다. 네트워크 간 구성에는 RouteBased VpnType이 필요합니다. 종종 선택한 VPN 게이트웨이 SKU에 따라 VPN 게이트웨이를 만드는 데 45분 이상 걸릴 수 있습니다.

1. Azure Portal 홈 페이지에서 **리소스 만들기**를 선택합니다.
2. 검색 텍스트 상자에서 **가상 네트워크 게이트웨이**를 입력하고, **Enter** 키를 누릅니다.
3. **가상 네트워크 게이트웨이**, **만들기**를 차례로 선택합니다.
4. **이름**에 대해 **GW-hub**를 입력합니다.
5. **지역**에 대해 **(US) 미국 동부**를 선택합니다.
6. **게이트웨이 유형**에 대해 **VPN**을 선택합니다.
7. **VPN 종류**에 대해 **경로 기반**을 선택합니다.
8. **SKU**에 대해 **기본**을 선택합니다.
9. **가상 네트워크**에 대해 **VNet-hub**를 선택합니다.
10. **공용 IP 주소**에 대해 **새로 만들기**를 선택하고, 이름으로 **VNet-hub-GW-pip**를 입력합니다.
11. 나머지 항목에 대해 기본값을 적용한 다음, **검토 + 만들기**를 선택합니다.
12. 구성을 검토한 다음, **만들기**를 선택합니다.

### <a name="create-a-vpn-gateway-for-the-on-premises-virtual-network"></a>온-프레미스 가상 네트워크에 대한 VPN Gateway 만들기

이제 온-프레미스 가상 네트워크에 대한 VPN Gateway를 만듭니다. 네트워크 간 구성에는 RouteBased VpnType이 필요합니다. 종종 선택한 VPN 게이트웨이 SKU에 따라 VPN 게이트웨이를 만드는 데 45분 이상 걸릴 수 있습니다.

1. Azure Portal 홈 페이지에서 **리소스 만들기**를 선택합니다.
2. 검색 텍스트 상자에서 **가상 네트워크 게이트웨이**를 입력하고, **Enter** 키를 누릅니다.
3. **가상 네트워크 게이트웨이**, **만들기**를 차례로 선택합니다.
4. **이름**에 대해 **GW-Onprem**을 입력합니다.
5. **지역**에 대해 **(US) 미국 동부**를 선택합니다.
6. **게이트웨이 유형**에 대해 **VPN**을 선택합니다.
7. **VPN 종류**에 대해 **경로 기반**을 선택합니다.
8. **SKU**에 대해 **기본**을 선택합니다.
9. **가상 네트워크**에 대해 **VNet-Onprem**을 선택합니다.
10. **공용 IP 주소**에 대해 **기존 항목 사용*을 선택하고, 이름에 대해 **VNet-Onprem-GW-pip**를 선택합니다.
11. 나머지 항목에 대해 기본값을 적용한 다음, **검토 + 만들기**를 선택합니다.
12. 구성을 검토한 다음, **만들기**를 선택합니다.

### <a name="create-the-vpn-connections"></a>VPN 연결 만들기

이제 허브와 온-프레미스 게이트웨이 간에 VPN 연결을 만들 수 있습니다.

이 단계에서는 허브 가상 네트워크에서 온-프레미스 가상 네트워크로의 연결을 만듭니다. 예제에서 참조된 공유 키를 볼 수 있습니다. 공유 키에 대해 고유한 값을 사용할 수 있습니다. 중요한 점은 두 연결에서 모두 공유 키가 일치해야 한다는 것입니다. 연결 만들기는 완료하는 데 꽤 오래 걸릴 수 있습니다.

1. **FW-Hybrid-Test** 리소스 그룹을 열고, **GW-hub** 게이트웨이를 선택합니다.
2. 왼쪽 열에서 **연결**을 선택합니다.
3. **추가**를 선택합니다.
4. 연결 이름에 대해 **Hub-to-Onprem**을 입력합니다.
5. **연결 형식**에 대해 **VNet 간**을 선택합니다.
6. **두 번째 가상 네트워크 게이트웨이**에 대해 **GW-Onprem**을 선택합니다.
7. **공유 키(PSK)** 에 대해 **AzureA1b2C3**을 입력합니다.
8. **확인**을 선택합니다.

온-프레미스에서 허브 가상 네트워크로의 연결을 만듭니다. 이 단계는 VNet-Onprem에서 VNet-hub로의 연결을 만든다는 점을 제외하고는 이전 단계와 유사합니다. 공유된 키가 일치하는지 확인합니다. 몇 분 후 연결이 설정됩니다.

1. **FW-Hybrid-Test** 리소스 그룹을 열고, **GW-Onprem** 게이트웨이를 선택합니다.
2. 왼쪽 열에서 **연결**을 선택합니다.
3. **추가**를 선택합니다.
4. 연결 이름에 대해 **nprem-to-Hub**를 입력합니다.
5. **연결 형식**에 대해 **VNet 간**을 선택합니다.
6. **두 번째 가상 네트워크 게이트웨이**에 대해 **GW-hub**를 선택합니다.
7. **공유 키(PSK)** 에 대해 **AzureA1b2C3**을 입력합니다.
8. **확인**을 선택합니다.


#### <a name="verify-the-connection"></a>연결 확인

약 5분 후에 두 연결의 상태가 **연결됨**이 됩니다.

![게이트웨이 연결](media/secure-hybrid-network/gateway-connections.png)

## <a name="peer-the-hub-and-spoke-virtual-networks"></a>허브 및 스포크 가상 네트워크 피어링

이제 허브 및 스포크 가상 네트워크를 피어링합니다.

1. **FW-Hybrid-Test** 리소스 그룹을 열고, **VNet-hub** 가상 네트워크를 선택합니다.
2. 왼쪽 열에서 **피어링**을 선택합니다.
3. **추가**를 선택합니다.
4. **이름**에 대해 **HubtoSpoke**를 입력합니다.
5. **가상 네트워크**에 대해 **VNet-spoke**를 선택합니다.
6. VNetSpoke에서 VNet-hub로의 피어링 이름에 대해 **SpoketoHub**를 입력합니다.
7. **게이트웨이 전송 허용**을 선택합니다.
8. **확인**을 선택합니다.

### <a name="configure-additional-settings-for-the-spoketohub-peering"></a>SpoketoHub 피어링에 대한 추가 설정 구성

SpoketoHub 피어링에서 **전달된 트래픽 허용**을 사용하도록 설정해야 합니다.

1. **FW-Hybrid-Test** 리소스 그룹을 열고, **VNet-Spoke** 가상 네트워크를 선택합니다.
2. 왼쪽 열에서 **피어링**을 선택합니다.
3. **SpoketoHub** 피어링을 선택합니다.
4. **VNet-hub에서 VNet-Spoke로 전달된 트래픽 허용** 아래에서 **사용**을 선택합니다.
5. **저장**을 선택합니다.

## <a name="create-the-routes"></a>경로 만들기

다음으로 두 경로 만듭니다.

- 허브 게이트웨이 서브넷에서 방화벽 IP 주소를 통해 스포크 서브넷으로 가는 경로
- 방화벽 IP 주소를 통해 스포크 서브넷으로부터의 기본 경로

1. Azure Portal 홈 페이지에서 **리소스 만들기**를 선택합니다.
2. 검색 텍스트 상자에서 **경로 테이블**을 입력하고, **Enter** 키를 누릅니다.
3. **경로 테이블**을 선택합니다.
4. **만들기**를 선택합니다.
5. 이름에 대해 **UDR-Hub-Spoke**를 입력합니다.
6. 리소스 그룹에 대해 **FW-Hybrid-Test**를 선택합니다.
8. **위치**에 대해 **(미국) 미국 동부**를 선택합니다.
9. **만들기**를 선택합니다.
10. 경로 테이블이 만들어지면 해당 테이블을 선택하여 경로 테이블 페이지를 엽니다.
11. 왼쪽 열에서 **경로**를 선택합니다.
12. **추가**를 선택합니다.
13. 경로 이름에 대해 **ToSpoke**를 입력합니다.
14. 주소 접두사에 대해 **10.6.0.0/16**을 입력합니다.
15. 다음 홉 형식에 대해 **가상 어플라이언스**를 선택합니다.
16. 다음 홉 주소에 대해 앞에서 적어둔 방화벽의 개인 IP 주소를 입력합니다.
17. **확인**을 선택합니다.

이제 경로를 서브넷에 연결합니다.

1. **UDR-Hub-Spoke - 경로** 페이지에서 **서브넷**을 선택합니다.
2. **연결**을 선택합니다.
4. **가상 네트워크** 아래에서 **VNet-hub**를 선택합니다.
5. **서브넷** 아래에서 **GatewaySubnet**을 선택합니다.
6. **확인**을 선택합니다.

이제 스포크 서브넷에서 기본 경로를 만듭니다.

1. Azure Portal 홈 페이지에서 **리소스 만들기**를 선택합니다.
2. 검색 텍스트 상자에서 **경로 테이블**을 입력하고, **Enter** 키를 누릅니다.
3. **경로 테이블**을 선택합니다.
5. **만들기**를 선택합니다.
6. 이름에 대해 **UDR-DG**를 입력합니다.
7. 리소스 그룹에 대해 **FW-Hybrid-Test**를 선택합니다.
8. **위치**에 대해 **(미국) 미국 동부**를 선택합니다.
4. **가상 네트워크 게이트웨이 경로 전파**에 대해 **사용 안 함**을 선택합니다.
1. **만들기**를 선택합니다.
2. 경로 테이블이 만들어지면 해당 테이블을 선택하여 경로 테이블 페이지를 엽니다.
3. 왼쪽 열에서 **경로**를 선택합니다.
4. **추가**를 선택합니다.
5. 경로 이름에 대해 **ToHub**를 입력합니다.
6. 주소 접두사에 대해 **0.0.0.0/0**을 입력합니다.
7. 다음 홉 형식에 대해 **가상 어플라이언스**를 선택합니다.
8. 다음 홉 주소에 대해 앞에서 적어둔 방화벽의 개인 IP 주소를 입력합니다.
9. **확인**을 선택합니다.

이제 경로를 서브넷에 연결합니다.

1. **UDR-DG - 경로** 페이지에서 **서브넷**을 선택합니다.
2. **연결**을 선택합니다.
4. **가상 네트워크** 아래에서 **VNet-spoke**를 선택합니다.
5. **서브넷** 아래에서 **SN-Workload**를 선택합니다.
6. **확인**을 선택합니다.

## <a name="create-virtual-machines"></a>가상 머신 만들기

이제 스포크 워크로드 및 온-프레미스 가상 머신을 만들어 적절한 서브넷에 배치합니다.

### <a name="create-the-workload-virtual-machine"></a>워크로드 가상 머신 만들기

스포크 가상 네트워크에서 공용 IP 주소 없이 IIS를 실행하는 가상 머신을 만듭니다.

1. Azure Portal 홈 페이지에서 **리소스 만들기**를 선택합니다.
2. **인기** 아래에서 **Windows Server 2016 Datacenter**를 선택합니다.
3. 가상 머신에 대해 다음 값을 입력합니다.
    - **리소스 그룹** - **FW-Hybrid-Test**를 선택합니다.
    - **가상 머신 이름**: *VM-Spoke-01*
    - **지역** -  *(US) 미국 동부*
    - **사용자 이름**: *azureuser*
    - **암호**: 암호 입력

4. **다음: 디스크**를 선택합니다.
5. 기본값을 그대로 적용하고 **다음: 네트워킹**을 선택합니다.
6. 가상 네트워크에 대해 **VNet-Spoke**를 선택하고, 서브넷은 **SN-Workload**입니다.
7. **공용 IP**에 대해 **없음**을 선택합니다.
8. **공용 인바운드 포트**에 대해 **선택한 포트 허용**을 선택한 다음, **HTTP(80)** 및 **RDP(3389)** 를 선택합니다.
9. **다음: 관리**를 선택합니다.
10. **부트 진단**에 대해 **끄기**를 선택합니다.
11. **검토 + 만들기**를 선택하고, 요약 페이지에서 설정을 검토한 다음, **만들기**를 선택합니다.

### <a name="install-iis"></a>IIS 설치

1. Azure Portal에서 Cloud Shell을 열고, **PowerShell**로 설정되어 있는지 확인합니다.
2. 다음 명령을 실행하여 가상 머신에 IIS를 설치하고 필요한 경우 위치를 변경합니다.

   ```azurepowershell-interactive
   Set-AzVMExtension `
           -ResourceGroupName FW-Hybrid-Test `
           -ExtensionName IIS `
           -VMName VM-Spoke-01 `
           -Publisher Microsoft.Compute `
           -ExtensionType CustomScriptExtension `
           -TypeHandlerVersion 1.4 `
           -SettingString '{"commandToExecute":"powershell Add-WindowsFeature Web-Server; powershell      Add-Content -Path \"C:\\inetpub\\wwwroot\\Default.htm\" -Value $($env:computername)"}' `
           -Location EastUS
   ```

### <a name="create-the-on-premises-virtual-machine"></a>온-프레미스 가상 머신 만들기

원격 데스크톱을 사용하여 공용 IP 주소에 연결하는 데 사용하는 가상 머신입니다. 여기에서 방화벽을 통해 온-프레미스 서버에 연결할 수 있습니다.

1. Azure Portal 홈 페이지에서 **리소스 만들기**를 선택합니다.
2. **인기** 아래에서 **Windows Server 2016 Datacenter**를 선택합니다.
3. 가상 머신에 대해 다음 값을 입력합니다.
    - **리소스 그룹** - 기존 항목을 선택한 다음, **FW-Hybrid-Test**를 선택합니다.
    - **가상 머신 이름** - *VM-Onprem*
    - **지역** -  *(US) 미국 동부*
    - **사용자 이름**: *azureuser*
    - **암호**: 암호 입력

4. **다음: 디스크**를 선택합니다.
5. 기본값을 적용하고, **다음: 네트워킹**을 선택합니다.
6. 가상 네트워크에 대해 **VNet-Onprem**을 선택하고, 서브넷이 **SN-Corp**인지 확인합니다.
7. **공용 인바운드 포트**에 대해 **선택한 포트 허용**을 선택한 다음, **RDP(3389)** 를 선택합니다.
8. **다음: 관리**를 선택합니다.
9. **부트 진단**에 대해 **끄기**를 선택합니다.
10. **검토 + 만들기**를 선택하고, 요약 페이지에서 설정을 검토한 다음, **만들기**를 선택합니다.

## <a name="test-the-firewall"></a>방화벽 테스트

1. 먼저 VM-Spoke-01 개요 페이지에서 VM-Spoke-01 가상 머신에 대한 개인 IP 주소를 확인합니다.

2. Azure Portal에서 **VM-Onprem** 가상 머신에 연결합니다.
<!---2. Open a Windows PowerShell command prompt on **VM-Onprem**, and ping the private IP for **VM-spoke-01**.

   You should get a reply.--->
3. **VM-Onprem**에서 웹 브라우저를 열고 http://\<VM-spoke-01 프라이빗 IP\>로 이동합니다.

   **VM-spoke-01** 웹 페이지가 표시됩니다. ![VM-spoke-01 웹 페이지](media/secure-hybrid-network/vm-spoke-01-web.png)

4. **VM-Onprem** 가상 머신에서 개인 IP 주소의 **VM-spoke-01**에 대한 원격 데스크톱을 엽니다.

   연결이 성공하고 로그인할 수 있습니다.

이제 방화벽 규칙이 작동하는지 확인했습니다.

<!---- You can ping the server on the spoke VNet.--->
- 스포크 가상 네트워크에서 웹 서버를 탐색할 수 있습니다.
- RDP를 사용하여 스포크 가상 네트워크에 있는 서버에 연결할 수 있습니다.

이제 방화벽 규칙이 예상대로 작동하는지 호가인하기 위해 방화벽 네트워크 규칙 수집 동작을 **거부**로 변경합니다.

1. **FW-Hybrid-Test** 리소스 그룹을 열고, **Pol-Net01** 방화벽 정책을 선택합니다.
2. **설정** 아래에서 **규칙**을 선택합니다.
3. **네트워크 규칙** 아래에서 **RCNet01** 규칙 컬렉션, 줄임표(...), **편집**을 차례로 선택합니다.
4. **규칙 컬렉션 작업**에 대해 **거부**를 선택합니다.
5. **저장**을 선택합니다.

변경된 규칙을 테스트하려면 먼저 **VM-Onprem**에서 기존 원격 데스크톱 및 브라우저를 닫습니다. 규칙 컬렉션 업데이트가 완료되면 테스트를 다시 실행합니다. 이번에는 모두 실패해야 합니다.

## <a name="clean-up-resources"></a>리소스 정리

다음 자습서에서 사용하기 위해 방화벽 리소스를 그대로 유지하거나, 더 이상 필요하지 않은 경우 **FW-Hybrid-Test** 리소스 그룹을 삭제하여 모든 방화벽 관련 리소스를 삭제할 수 있습니다.

## <a name="next-steps"></a>다음 단계

> [!div class="nextstepaction"]
> [자습서: Azure Firewall Manager 미리 보기를 사용하여 가상 WAN 보호](secure-cloud-network.md)