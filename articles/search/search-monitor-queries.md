---
title: 쿼리 모니터링
titleSuffix: Azure Cognitive Search
description: 쿼리 메트릭을 모니터링하여 성능 및 처리량을 모니터링합니다. 진단 로그에서 쿼리 문자열 입력을 수집하고 분석합니다.
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 02/18/2020
ms.openlocfilehash: a3a313ef9cd74ba901f5a6a2d82a18e3c21145dc
ms.sourcegitcommit: 2ec4b3d0bad7dc0071400c2a2264399e4fe34897
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 03/27/2020
ms.locfileid: "77462527"
---
# <a name="monitor-query-requests-in-azure-cognitive-search"></a>Azure 인지 검색에서 쿼리 요청 모니터링

이 문서에서는 메트릭 및 진단 로깅을 사용하여 쿼리 성능 및 볼륨을 측정하는 방법을 설명합니다. 또한 검색 모음의 유용성과 효과를 평가해야 할 때 필요한 정보인 쿼리에 사용되는 입력 용어를 수집하는 방법에 대해서도 설명합니다.

메트릭에 피드되는 기록 데이터는 30일 동안 보존됩니다. 보존 기간을 연장하거나 운영 데이터 및 쿼리 문자열을 보고하려면 기록된 이벤트 및 메트릭을 지속하기 위한 저장소 옵션을 지정하는 [진단 설정을](search-monitor-logs.md) 사용하도록 설정해야 합니다.

데이터 측정의 무결성을 최대화하는 조건은 다음과 같습니다.

+ 청구 가능한 서비스(기본 또는 표준 계층에서 만든 서비스)를 사용합니다. 무료 서비스는 여러 구독자가 공유하므로 부하가 이동함에 따라 일정량의 변동성이 발생합니다.

+ 가능하면 단일 복제본 및 파티션을 사용하여 포함된 격리된 환경을 만듭니다. 여러 복제본을 사용하는 경우 쿼리 메트릭은 여러 노드에서 평균화되어 결과의 정밀도를 낮출 수 있습니다. 마찬가지로 여러 파티션은 데이터가 분할된다는 것을 의미하며 인덱싱이 진행 중인 경우 일부 파티션에 다른 데이터가 있을 수 있습니다. 쿼리 성능을 튜닝할 때 단일 노드 및 파티션은 테스트를 위한 보다 안정적인 환경을 제공합니다.

> [!Tip]
> 추가 클라이언트 측 코드 및 Application Insights를 사용하면 클릭스루 데이터를 캡처하여 응용 프로그램 사용자의 관심을 끄는 것에 대한 심층적인 통찰력을 얻을 수도 있습니다. 자세한 내용은 [트래픽 분석 검색](search-traffic-analytics.md)을 참조하세요.

## <a name="query-volume-qps"></a>쿼리 볼륨(QPS)

볼륨은 1분 기간 내에 실행되는 쿼리의 평균, 개수, 최소 값 또는 최대 값으로 보고될 수 있는 기본 제공 메트릭인 초당 검색 쿼리(QPS)로 측정됩니다. **Search Queries Per Second** 메트릭에 대한 1분 간격(TimeGrain = "PT1M")은 시스템 내에서 고정됩니다.

쿼리가 밀리초 단위로 실행되는 것이 일반적이므로 초단위로 측정하는 쿼리만 메트릭에 표시됩니다.

| 집계 형식 | 설명 |
|------------------|-------------|
| 평균 | 쿼리 실행이 발생한 1분 내의 평균 초입니다.|
| 개수 | 1분 간격 내에 로그에 내보내는 메트릭 수입니다. |
| 최대 | 1분 동안 등록된 초당 검색 쿼리 수가 가장 높습니다. |
| 최소 | 1분 동안 등록된 초당 검색 쿼리 수가 가장 낮습니다.  |
| 합계 | 분 내에 실행된 모든 쿼리의 합계입니다.  |

예를 들어 1분 이내에 SearchQuerysPerSecond의 최대값인 고부하의 1초, 평균 로드의 58초, 마지막으로 최소 쿼리가 하나인 쿼리 가 하나만 있는 1초의 패턴이 있을 수 있습니다.

또 다른 예: 노드가 각 메트릭의 값이 40인 100개의 메트릭을 내림차민 경우 "Count"는 100이고, "Sum"은 4000, "평균"은 40, '최대'는 40입니다.

## <a name="query-performance"></a>쿼리 성능

서비스 전반에 걸친 쿼리 성능은 리소스 경합의 결과로 삭제된 검색 대기 시간(쿼리를 완료하는 데 걸리는 시간)과 제한된 쿼리로 측정됩니다.

### <a name="search-latency"></a>검색 대기 시간

| 집계 형식 | 대기 시간 | 
|------------------|---------|
| 평균 | 평균 쿼리 기간은 밀리초입니다. | 
| 개수 | 1분 간격 내에 로그에 내보내는 메트릭 수입니다. |
| 최대 | 샘플에서 가장 긴 실행 중인 쿼리입니다. | 
| 최소 | 샘플에서 가장 짧은 실행 쿼리입니다.  | 
| 합계 | 간격(1분) 내에 실행되는 샘플의 모든 쿼리의 총 실행 시간입니다.  |

**검색 대기 시간** 메트릭의 다음 예를 살펴보겠습니다: 평균 기간이 23.26밀리초인 86개의 쿼리가 샘플링되었습니다. 최소 0은 일부 쿼리가 삭제했음을 나타냅니다. 가장 긴 실행 쿼리를 완료하는 데 1000밀리초가 걸렸습니다. 총 실행 시간은 2초였습니다.

![대기 시간 집계](./media/search-monitor-usage/metrics-latency.png "대기 시간 집계")

### <a name="throttled-queries"></a>제한 쿼리

제한 쿼리는 프로세스 대신 삭제된 쿼리를 나타냅니다. 대부분의 경우 제한은 서비스 실행의 정상적인 부분입니다.  그것은 반드시 뭔가 잘못이 있다는 표시는 아닙니다.

제한은 현재 처리된 요청 수가 사용 가능한 리소스를 초과할 때 발생합니다. 복제본을 회전에서 제거하거나 인덱싱 하는 동안 제한 된 요청이 증가 할 수 있습니다. 쿼리 및 인덱싱 요청은 모두 동일한 리소스 집합에 의해 처리됩니다.

서비스는 리소스 사용량에 따라 요청을 삭제할지 여부를 결정합니다. 메모리, CPU 및 디스크 IO에서 소비되는 리소스의 백분율은 일정 기간 동안 평균화됩니다. 이 비율이 임계값을 초과하면 요청 량이 줄어들 때까지 인덱스에 대한 모든 요청이 제한됩니다. 

클라이언트에 따라 다음과 같은 방법으로 제한된 요청을 표시할 수 있습니다.

+ 서비스가 "너무 많은 요청을 보내고 있습니다. 나중에 다시 시도하십시오." 
+ 서비스가 현재 서비스를 사용할 수 없음을 나타내는 503 오류 코드를 반환합니다. 
+ 포털(예: 검색 탐색기)을 사용하는 경우 쿼리가 자동으로 삭제되고 검색을 다시 클릭해야 합니다.

제한된 쿼리를 확인하려면 **제한 검색 쿼리 메트릭을** 사용합니다. 포털에서 메트릭을 탐색하거나 이 문서에 설명된 대로 경고 메트릭을 만들 수 있습니다. 샘플링 간격 내에 삭제된 쿼리의 경우 *Total을* 사용하여 실행되지 않은 쿼리의 백분율을 가져옵니다.

| 집계 형식 | 스로틀 |
|------------------|-----------|
| 평균 | 간격 내에 삭제된 쿼리의 백분율입니다. |
| 개수 | 1분 간격 내에 로그에 내보내는 메트릭 수입니다. |
| 최대 | 간격 내에 삭제된 쿼리의 백분율입니다.|
| 최소 | 간격 내에 삭제된 쿼리의 백분율입니다. |
| 합계 | 간격 내에 삭제된 쿼리의 백분율입니다. |

**제한 검색 쿼리 비율의**경우 최소, 최대, 평균 및 합계모두 1분 동안의 총 검색 쿼리 수에서 제한된 검색 쿼리의 백분율과 같은 값을 가집니다.

다음 스크린샷에서 첫 번째 숫자는 로그에 전송된 메트릭 수입니다. 메트릭 위로 마우스를 가져가면 맨 위에 나타나는 추가 집계에는 평균, 최대 및 합계가 포함됩니다. 이 샘플에서는 요청이 삭제되지 않았습니다.

![제한 집계](./media/search-monitor-usage/metrics-throttle.png "제한 집계")

## <a name="explore-metrics-in-the-portal"></a>포털에서 측정항목 탐색

현재 숫자를 빠르게 살펴보기 위해 서비스 개요 페이지의 **모니터링** 탭에는 집계 유형을 변경하는 옵션을 사용하여 시간, 일 및 주로 측정된 고정 간격에 대해 세 가지 메트릭(검색**대기 시간,** **초당 검색 쿼리(검색 단위당 검색 쿼리 비율)** 등이 표시됩니다. **Throttled Search Queries Percentage**

심층적인 탐색을 위해 **모니터링** 메뉴에서 메트릭 탐색기를 열어 데이터를 계층화, 확대 및 시각화하여 추세 또는 이상 징후를 탐색할 수 있습니다. 메트릭 [차트를 만드는](https://docs.microsoft.com/azure/azure-monitor/learn/tutorial-metrics-explorer)방법에 대한 이 자습서를 완료하여 메트릭 탐색기에 대해 자세히 알아봅니다.

1. 모니터링 섹션에서 **메트릭을** 선택하여 검색 서비스로 설정된 범위를 사용하여 메트릭 탐색기를 엽니다.

1. 메트릭에서 드롭다운 목록에서 하나를 선택하고 기본 설정 유형에 사용할 수 있는 집계 목록을 검토합니다. 집계는 수집된 값을 각 시간 간격에 대해 샘플링하는 방법을 정의합니다.

   ![QPS 메트릭에 대한 메트릭 탐색기](./media/search-monitor-usage/metrics-explorer-qps.png "QPS 메트릭에 대한 메트릭 탐색기")

1. 오른쪽 상단 모서리에서 시간 간격을 설정합니다.

1. 시각화를 선택합니다. 기본값은 선도차트입니다.

1. **메트릭 추가를** 선택하고 다른 집계를 선택하여 추가 집계를 계층화합니다.

1. 표선 표식의 관심 영역을 확대합니다. 영역의 시작 부분에 마우스 포인터를 놓고 마우스 왼쪽 단추를 누른 채 영역의 반대쪽으로 끈 후 단추를 놓습니다. 그러면 해당 시간 범위에서 차트가 확대됩니다.

## <a name="identify-strings-used-in-queries"></a>쿼리에 사용되는 문자열 식별

진단 로깅을 사용하도록 설정하면 시스템은 AzureDiagnostics 테이블에서 쿼리 요청을 **캡처합니다.** 전제 조건으로 로그 분석 작업 영역 또는 다른 저장소 옵션을 지정하는 [진단 로깅을](search-monitor-logs.md)이미 사용하도록 설정해야 합니다.

1. 모니터링 섹션에서 **로그를** 선택하여 로그 분석에서 빈 쿼리 창을 엽니다.

1. 다음 식을 실행하여 Query.Search 작업을 검색하고 작업 이름, 쿼리 문자열, 쿼리된 인덱스 및 발견된 문서 수로 구성된 테이블 형식 결과 집합을 반환합니다. 마지막 두 문은 샘플 인덱스를 통해 빈 검색 또는 지정되지 않은 검색으로 구성된 쿼리 문자열을 제외하므로 결과의 노이즈가 줄어납니다.

   ```
   AzureDiagnostics
   | project OperationName, Query_s, IndexName_s, Documents_d
   | where OperationName == "Query.Search"
   | where Query_s != "?api-version=2019-05-06&search=*"
   | where IndexName_s != "realestate-us-sample-index"
   ```

1. 선택적으로 *Query_s* 열 필터를 설정하여 특정 구문이나 문자열을 검색합니다. 예를 들어 필터링할 수 *있는 것은 )와* `?api-version=2019-05-06&search=*&%24filter=HotelName`같습니다.

   ![기록된 쿼리 문자열](./media/search-monitor-usage/log-query-strings.png "기록된 쿼리 문자열")

이 기술은 임시 조사에 작동하지만 보고서를 작성하면 쿼리 문자열을 통합하고 분석에 더 도움이 되는 레이아웃으로 표시할 수 있습니다.

## <a name="identify-long-running-queries"></a>장기 실행 쿼리 식별

기간 열을 추가하여 메트릭으로 선택된 쿼리뿐만 아니라 모든 쿼리에 대한 숫자를 가져옵니다. 이 데이터를 정렬하면 완료하는 데 가장 오래 걸리는 쿼리가 표시됩니다.

1. 모니터링 섹션에서 **로그를** 선택하여 로그 정보를 쿼리합니다.

1. 다음 쿼리를 실행하여 기간별로 밀리초단위로 정렬된 쿼리를 반환합니다. 가장 오래 실행되는 쿼리가 맨 위에 있습니다.

   ```
   AzureDiagnostics
   | project OperationName, resultSignature_d, DurationMs, Query_s, Documents_d, IndexName_s
   | where OperationName == "Query.Search"
   | sort by DurationMs
   ```

   ![기간별로 쿼리 정렬](./media/search-monitor-usage/azurediagnostics-table-sortby-duration.png "기간별로 쿼리 정렬")

## <a name="create-a-metric-alert"></a>메트릭 경고 만들기

메트릭 경고는 알림을 받거나 사전에 정의한 수정 작업을 트리거하는 임계값을 설정합니다. 

검색 서비스의 경우 검색 대기 시간 및 제한 쿼리에 대한 메트릭 경고를 만드는 것이 일반적입니다. 쿼리가 삭제되는 시기를 알고 있는 경우 부하를 줄이거나 용량을 늘리는 해결 책을 찾을 수 있습니다. 예를 들어 인덱싱 중에 제한된 쿼리가 증가하는 경우 쿼리 작업이 가라앉을 때까지 쿼리를 연기할 수 있습니다.

특정 복제본 파티션 구성의 제한을 푸시할 때 QPS(쿼리 볼륨 임계값)에 대한 경고를 설정하는 것도 유용합니다.

1. 모니터링 섹션에서 경고를 선택한 다음 **+ 새 경고 규칙을** **클릭합니다.** 검색 서비스가 리소스로 선택되었는지 확인합니다.

1. 조건하에서 **추가를**클릭합니다.

1. 신호 논리를 구성합니다. 신호 유형의 경우 메트릭을 선택한 다음 신호를 **선택합니다.**

1. 신호를 선택한 후 차트를 사용하여 기록 데이터를 시각화하여 조건 설정 진행 방법에 대한 정보에 입각한 결정을 내릴 수 있습니다.

1. 다음으로 아래로 스크롤하여 경고 논리로 이동합니다. 개념 증명의 경우 테스트 목적으로 인위적으로 낮은 값을 지정할 수 있습니다.

   ![경고 논리](./media/search-monitor-usage/alert-logic-qps.png "경고 논리")

1. 다음으로 작업 그룹을 지정하거나 만듭니다. 임계값이 충족될 때 호출하는 응답입니다. 푸시 알림 또는 자동 응답일 수 있습니다.

1. 마지막으로 경고 세부 정보를 지정합니다. 경고의 이름을 지정하고 설명하고, 심각도 값을 할당하고, 활성화된 상태또는 사용 안 함 상태에서 규칙을 만들지 여부를 지정합니다.

   ![경고 세부 정보](./media/search-monitor-usage/alert-details.png "경고 세부 정보")

전자 메일 알림을 지정하면 "Azure: 활성화된 심각도: 3"이라는 `<your rule name>`제목줄이 있는 "Microsoft Azure"의 전자 메일을 받게 됩니다.

<!-- ## Report query data

Power BI is an analytical reporting tool useful for visualizing data, including log information. If you are collecting data in Blob storage, a Power BI template makes it easy to spot anomalies or trends. Use this link to download the template. -->

## <a name="next-steps"></a>다음 단계

아직 수행하지 않은 경우 검색 서비스 모니터링의 기본 을 검토하여 전체 범위의 감독 기능에 대해 알아봅니다.

> [!div class="nextstepaction"]
> [Azure 인지 검색에서 작업 및 활동 모니터링](search-monitor-usage.md)