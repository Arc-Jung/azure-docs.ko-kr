---
title: 디바이스 그룹에 대한 자동 배포 - Azure IoT Edge | Microsoft Docs
description: Azure IoT Edge에서 자동 배포를 사용하여 공유 태그를 기준으로 디바이스 그룹 관리
author: kgremban
manager: philmea
ms.author: kgremban
ms.date: 01/30/2020
ms.topic: conceptual
ms.service: iot-edge
services: iot-edge
ms.openlocfilehash: 3989ec4ca2b5c9d7385841604678791b20c1d102
ms.sourcegitcommit: 4bda786435578ec7d6d94c72ca8642ce47ac628a
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 03/16/2021
ms.locfileid: "103489985"
---
# <a name="understand-iot-edge-automatic-deployments-for-single-devices-or-at-scale"></a>단일 디바이스 또는 대규모 IoT Edge 자동 배포 이해

[!INCLUDE [iot-edge-version-all-supported](../../includes/iot-edge-version-all-supported.md)]

자동 배포 및 계층화 된 배포는 많은 수의 IoT Edge 장치에서 모듈을 관리 하 고 구성 하는 데 도움이 됩니다.

Azure IoT Edge은 IoT Edge 장치에서 실행 되도록 모듈을 구성 하는 두 가지 방법을 제공 합니다. 첫 번째 방법은 장치 별로 모듈을 배포 하는 것입니다. 배포 매니페스트를 만든 다음 이름으로 특정 장치에 적용 합니다. 두 번째 방법은 정의 된 조건 집합을 충족 하는 등록 된 장치에 모듈을 자동으로 배포 하는 것입니다. 배포 매니페스트를 만든 다음 장치 [쌍의 태그](../iot-edge/how-to-deploy-at-scale.md#identify-devices-using-tags) 를 기준으로 배포 매니페스트를 적용 하는 장치를 정의 합니다.

이 문서에서는 대규모 장치를 구성 하 고 모니터링 하는 방법을 집중적으로 설명 하며, 이러한 장치를 *IoT Edge 자동 배포* 라고 통칭 합니다. 기본 배포 단계는 다음과 같습니다.

1. 운영자는 모듈 집합과 대상 장치를 설명 하는 배포를 정의 합니다. 각 배포에는 이 정보를 반영하는 배포 매니페스트가 있습니다.
2. IoT Hub 서비스는 모든 대상 장치와 통신 하 여 선언 된 모듈을 사용 하 여 구성 합니다.
3. IoT Hub 서비스는 IoT Edge 디바이스에서 상태를 검색하여 운영자에게 제공합니다.  예를 들어,에 지 장치가 성공적으로 구성 되지 않았거나 런타임 중에 모듈이 실패 한 경우 운영자에 게 표시 될 수 있습니다.
4. 언제든지 대상 조건에 맞는 새 IoT Edge 디바이스가 배포되도록 구성됩니다.

이 문서에서는 배포 구성 및 모니터링과 관련된 각 구성 요소를 설명합니다. 배포 만들기 및 업데이트에 대한 연습은 [대규모 IoT Edge 모듈 배포 및 모니터링](how-to-deploy-at-scale.md)을 참조하세요.

## <a name="deployment"></a>배포

IoT Edge 자동 배포는 대상 IoT Edge 디바이스 집합에서 인스턴스로 실행되도록 IoT Edge 모듈 이미지를 할당합니다. 이는 해당 초기화 매개 변수가 있는 모듈의 목록을 포함하도록 IoT Edge 배포 매니페스트를 구성하여 작동합니다. 배포는 단일 디바이스(디바이스 ID 기반) 또는 디바이스 그룹(태그 기반)에 할당할 수 있습니다. IoT Edge 디바이스는 배포 매니페스트를 받은 후 해당 컨테이너 리포지토리에서 컨테이너 이미지를 다운로드하고 설치한 다음 적절하게 구성합니다. 배포가 만들어지면 운영자가 배포 상태를 모니터링하여 대상 디바이스가 제대로 구성되었는지 확인할 수 있습니다.

IoT Edge 디바이스만 배포를 사용하여 구성할 수 있습니다. 배포를 수신하기 전에 다음 필수 구성 요소가 디바이스에 있어야 합니다.

* 기본 운영 체제
* Moby 또는 Docker와 같은 컨테이너 관리 시스템
* IoT Edge 런타임 프로비전

### <a name="deployment-manifest"></a>배포 매니페스트

배포 매니페스트는 대상 IoT Edge 디바이스에 구성할 모듈을 설명하는 JSON 문서입니다. 여기에는 필요한 시스템 모듈(특히 IoT Edge 에이전트 및 IoT Edge 허브)을 포함하여 모든 모듈에 대한 구성 메타데이터가 포함되어 있습니다.  

각 모듈의 구성 메타데이터에는 다음 항목이 포함됩니다.

* 버전
* 유형
* 상태(예: 실행 중 또는 중지됨)
* 정책 다시 시작
* 이미지 및 컨테이너 레지스트리
* 데이터 입력 및 출력 경로

모듈 이미지가 프라이빗 컨테이너 레지스트리에 저장된 경우 IoT Edge 에이전트는 레지스트리 자격 증명을 보관합니다.

### <a name="target-condition"></a>대상 조건

대상 조건은 배포 수명 내내 지속적으로 평가 됩니다. 요구 사항을 충족하는 새 디바이스가 모두 포함되고, 더 이상 요구 사항을 충족하지 않는 기존 디바이스는 제거됩니다. 서비스에서 대상 조건 변경을 탐지하면 배포가 다시 활성화됩니다.

예를 들어 대상 조건 태그를 포함 하는 배포를 사용할 수 있습니다. environment = ' prod '. 배포를 시작할 때는 10개의 프로덕션 디바이스가 있습니다. 이 10개 디바이스에 모듈이 성공적으로 설치됩니다. IoT Edge 에이전트 상태는 총 10 개 장치, 성공한 응답 10 개, 실패 응답 0 개 및 보류 중인 응답 0 개를 표시 합니다. 이제 tags.environment = 'prod'인 디바이스 5개를 추가합니다. 이 서비스는 변경 내용을 검색 하 고, 에이전트 상태 IoT Edge는 총 15 개 장치, 성공한 응답 10 개, 실패 한 응답 0 개 및 5 개의 새 장치에 배포 하는 동안 보류 중인 응답 5 개가 됩니다.

장치 쌍 태그, 장치 쌍 보고 속성 또는 deviceId에 부울 조건을 사용 하 여 대상 장치를 선택 합니다. 태그가 있는 조건을 사용하려면 속성과 동일한 수준의 디바이스 쌍에 "tags":{} 섹션을 추가해야 합니다. [디바이스 쌍의 태그에 대해 자세히 알아보기](../iot-hub/iot-hub-devguide-device-twins.md)

대상 조건의 예:

* deviceId ='linuxprod1'
* tags.environment ='prod'
* tags.environment = 'prod' AND tags.location = 'westus'
* tags.environment = 'prod' OR tags.location = 'westus'
* tags. operator = ' John ' 및 태그. environment = ' prod ' 및 no deviceId = ' linuxprod1 '
* devicemodel = ' 4000x '

대상 조건을 생성할 때 다음 제약 조건을 고려 합니다.

* 장치 쌍에서 태그, 보고 된 속성 또는 deviceId를 사용 하 여 대상 조건만 만들 수 있습니다.
* 큰따옴표는 대상 조건의 어떤 부분에도 허용되지 않습니다. 작은따옴표를 사용합니다.
* 작은따옴표는 대상 조건의 값을 나타냅니다. 따라서 작은따옴표가 디바이스 이름의 일부인 경우 또 다른 작은따옴표로 작은따옴표를 이스케이프해야 합니다. 예를 들어 `operator'sDevice`라는 디바이스를 대상으로 지정하려면 `deviceId='operator''sDevice'`라고 씁니다.
* 숫자, 문자 및 특수 문자(`-:.+%_#*?!(),=@;$`)는 대상 조건 값에 사용할 수 있습니다.

### <a name="priority"></a>우선 순위

우선 순위는 배포가 다른 배포를 기준으로 대상 디바이스에 적용되어야 하는지 여부를 정의합니다. 배포 우선 순위는 양의 정수이며, 큰 숫자는 높은 우선 순위를 나타냅니다. IoT Edge 디바이스가 둘 이상의 배포 대상이 되는 경우 우선 순위가 가장 높은 배포가 적용됩니다.  우선 순위가 낮은 배포는 적용되지 않으며 병합되지 않습니다.  디바이스가 동등한 우선 순위를 갖는 둘 이상의 배포 대상으로 지정되면 가장 최근에 만든 배포(생성 타임스탬프 기준으로 결정됨)가 적용됩니다.

### <a name="labels"></a>레이블

레이블은 배포를 필터링 및 그룹화 하는 데 사용할 수 있는 문자열 키/값 쌍입니다. 배포에는 여러 개의 레이블이 있을 수 있습니다. 레이블은 선택 사항이 며 IoT Edge 장치의 실제 구성에 영향을 주지 않습니다.

### <a name="metrics"></a>메트릭

기본적으로 모든 배포는 다음 네 가지 메트릭에 대해 보고 합니다.

* **대상** 배포 대상 조건과 일치 하는 IoT Edge 장치를 표시 합니다.
* **적용** 됨에 따라 우선 순위가 높은 다른 배포의 대상이 아닌 대상 IoT Edge 장치가 표시 됩니다.
* **성공 보고** 에는 모듈이 성공적으로 배포 되었음을 보고 한 IoT Edge 장치가 표시 됩니다.
* **보고 실패** 는 하나 이상의 모듈이 성공적으로 배포 되지 않았음을 보고 한 IoT Edge 장치를 표시 합니다. 오류를 자세히 조사하려면 해당 디바이스에 원격으로 연결하고 로그 파일을 살펴봅니다.

또한 배포를 모니터링 하 고 관리 하는 데 도움이 되는 사용자 지정 메트릭을 직접 정의할 수 있습니다.

메트릭은 배포 구성 적용의 결과로 장치가 다시 보고할 수 있는 다양 한 상태의 요약 개수를 제공 합니다. 메트릭은 *lastDesiredStatus* 또는 *lastconnecttime* 과 같은 [보고 된 edgeHub 모듈 쌍 속성](module-edgeagent-edgehub.md#edgehub-reported-properties)을 쿼리할 수 있습니다. 예를 들면 다음과 같습니다.

```sql
SELECT deviceId FROM devices
  WHERE properties.reported.lastDesiredStatus.code = 200
```

사용자 고유의 메트릭을 추가 하는 것은 선택 사항이 며 IoT Edge 장치의 실제 구성에 영향을 주지 않습니다.

## <a name="layered-deployment"></a>계층화된 배포

계층화 된 배포는 생성 해야 하는 고유한 배포의 수를 줄이기 위해 함께 결합 될 수 있는 자동 배포입니다. 계층화 된 배포는 여러 자동 배포의 여러 조합에서 동일한 모듈이 재사용 되는 시나리오에서 유용 합니다.

계층화 된 배포에는 자동 배포와 동일한 기본 구성 요소가 있습니다. 장치 쌍의 태그를 기준으로 장치를 대상으로 지정 하 고 레이블, 메트릭 및 상태 보고와 동일한 기능을 제공 합니다. 계층화 된 배포에는 할당 된 우선 순위도 있지만 우선 순위를 사용 하 여 장치에 적용 되는 배포를 결정 하는 대신, 우선 순위에 따라 장치에서 여러 배포를 순위 지정 하는 방법이 결정 됩니다. 예를 들어 두 개의 계층화 된 배포에 동일한 이름의 모듈이 있거나 경로가 있는 경우 우선 순위가 더 높은 계층화 된 배포가 적용 되 고 낮은 우선 순위는 덮어쓰여집니다.

시스템 런타임 모듈 edgeAgent 및 edgeHub는 계층화 된 배포의 일부로 구성 되지 않습니다. 계층화 된 배포를 대상으로 하는 모든 IoT Edge 장치에는 먼저 표준 자동 배포를 적용 해야 합니다. 자동 배포는 계층화 된 배포를 추가할 수 있는 기반을 제공 합니다.

IoT Edge 장치는 표준 자동 배포를 하나 이상 적용할 수 있지만 계층화 된 자동 배포를 여러 개 적용할 수 있습니다. 장치를 대상으로 하는 계층화 된 배포는 해당 장치에 대 한 자동 배포 보다 우선 순위가 높아야 합니다.

예를 들어 건물을 관리 하는 회사의 시나리오는 다음과 같습니다. 보안 카메라, 동작 센서 및 엘리베이터에서 데이터를 수집 하기 위한 모듈 IoT Edge 개발 했습니다. 그러나 모든 건물이 세 모듈을 모두 사용할 수 있는 것은 아닙니다. 표준 자동 배포를 사용 하는 경우 회사는 건물이 필요로 하는 모든 모듈 조합에 대 한 개별 배포를 만들어야 합니다.

![표준 자동 배포는 모든 모듈 조합을 수용 해야 합니다.](./media/module-deployment-monitoring/standard-deployment.png)

그러나 회사에서 계층화 된 자동 배포로 전환 하 고 나면 관리할 배포의 수를 줄여서 동일한 모듈 조합을 만들 수 있습니다. 각 모듈에는 자체 계층화 된 배포가 있으며 장치 태그는 각 건물에 추가 되는 모듈을 식별 합니다.

![계층화 된 자동 배포는 동일한 모듈이 다른 방식으로 결합 되는 시나리오를 간소화 합니다.](./media/module-deployment-monitoring/layered-deployment.png)

### <a name="module-twin-configuration"></a>모듈 쌍 구성

계층화 된 배포로 작업할 때 의도적으로 또는 그렇지 않은 경우 장치를 대상으로 하는 동일한 모듈을 가진 두 개의 배포가 있을 수 있습니다. 이러한 경우 우선 순위가 높은 배포에서 모듈 쌍을 덮어쓸지 또는 추가 해야 하는지 여부를 결정할 수 있습니다. 예를 들어 동일한 모듈을 100 다른 장치에 적용 하는 배포가 있을 수 있습니다. 그러나 이러한 장치 중 10 개는 보안 기능에 있으며 프록시 서버를 통해 통신 하려면 추가 구성이 필요 합니다. 계층화 된 배포를 사용 하 여 기본 배포에서 기존 모듈 쌍 정보를 덮어쓰지 않고 해당 10 장치가 안전 하 게 통신할 수 있도록 하는 모듈 쌍 속성을 추가할 수 있습니다.

배포 매니페스트에 모듈 쌍 desired 속성을 추가할 수 있습니다. 표준 배포의 경우 속성에 속성을 추가 **합니다.** 모듈 쌍의 원하는 섹션에는 계층화 된 배포에서 desired 속성의 새 하위 집합을 선언할 수 있습니다.

예를 들어 표준 배포에서 5 초 간격으로 데이터를 보내도록 지시 하는 다음과 같은 desired 속성을 사용 하 여 시뮬레이션 된 온도 센서 모듈을 추가할 수 있습니다.

```json
"SimulatedTemperatureSensor": {
  "properties.desired": {
    "SendData": true,
    "SendInterval": 5
  }
}
```

동일한 장치의 일부 또는 모두를 대상으로 하는 계층화 된 배포에서 1000 메시지를 보내도록 시뮬레이션 된 센서에 지시 하는 속성을 추가 하 고 중지 합니다. 기존 속성을 덮어쓰지 않으려면 새 속성을 포함 하는 라는 desired 속성 내에 새 섹션을 만듭니다 `layeredProperties` .

```json
"SimulatedTemperatureSensor": {
  "properties.desired.layeredProperties": {
    "StopAfterCount": 1000
  }
}
```

두 배포를 모두 적용 한 장치는 시뮬레이션 된 온도 센서에 대 한 모듈 쌍의 다음 속성을 반영 합니다.

```json
"properties": {
  "desired": {
    "SendData": true,
    "SendInterval": 5,
    "layeredProperties": {
      "StopAfterCount": 1000
    }
  }
}
```

계층화 된 배포에서 모듈 쌍의 필드를 설정 하는 경우 `properties.desired` 우선 순위가 낮은 배포에서 해당 모듈에 대 한 desired 속성을 덮어씁니다.

## <a name="phased-rollout"></a>단계별 배포

단계별 배포는 운영자가 대규모 IoT Edge 디바이스 집합에 변경 내용을 배포하는 전체적인 프로세스입니다. 목표는 점진적으로 변경하여 광범위한 새로운 변경에 따른 위험을 줄이는 것입니다. 자동 배포를 통해 IoT Edge 장치에서 단계적 롤아웃을 관리할 수 있습니다.

단계별 배포는 다음과 같은 단계로 실행됩니다.

1. IoT Edge 디바이스를 프로비전하고 `tag.environment='test'`와 같이 디바이스 쌍 태그를 설정하여 해당 디바이스의 테스트 환경을 설정합니다. 테스트 환경은 배포에서 최종적인 대상이 되는 프로덕션 환경을 미러링해야 합니다.
2. 원하는 모듈 및 구성이 포함된 배포를 만듭니다. 대상 조건은 IoT Edge 디바이스 테스트 환경을 대상으로 해야 합니다.
3. 테스트 환경에서 새 모듈 구성의 유효성을 검사합니다.
4. 대상 조건에 새 태그를 추가하여 프로덕션 IoT Edge 디바이스의 하위 집합이 포함되도록 배포를 업데이트합니다. 또한 배포 우선 순위가 현재의 해당 디바이스를 대상으로 하는 다른 배포보다 더 높은지 확인합니다
5. 배포 상태를 확인하여 대상 IoT 디바이스에 대한 배포가 성공했는지 확인합니다.
6. 나머지 모든 프로덕션 IoT Edge 디바이스를 대상으로 지정하도록 배포를 업데이트합니다.

## <a name="rollback"></a>롤백

오류 또는 잘못된 구성이 표시되면 배포를 롤백할 수 있습니다. 배포는 IoT Edge 디바이스에 대한 절대적인 모듈 구성을 정의하므로, 모든 모듈을 제거하는 것이 목표인 경우에도 우선 순위가 낮은 동일한 디바이스에 추가 배포를 대상으로 지정해야 합니다.  

배포를 삭제 해도 대상 장치에서 모듈이 제거 되지 않습니다. 빈 배포 인 경우에도 장치의 새 구성을 정의 하는 다른 배포가 있어야 합니다.

롤백을 수행하는 순서는 다음과 같습니다.

1. 동일한 디바이스 집합에도 추가 배포가 대상으로 지정되었는지 확인합니다. 롤백의 목표가 모든 모듈을 제거하는 것이면 추가 배포에 모듈이 포함되면 안됩니다.
2. 디바이스가 더 이상 대상 조건을 충족하지 못하도록 롤백하려는 배포의 대상 조건식을 수정하거나 제거합니다.
3. 배포 상태를 확인하여 롤백이 성공했는지 확인합니다.
   * 롤백된 배포에는 더 이상 롤백된 디바이스의 상태가 표시되지 않아야 합니다.
   * 이제 추가 배포에는 롤백된 디바이스의 배포 상태가 포함됩니다.

## <a name="next-steps"></a>다음 단계

* [대규모 IoT Edge 모듈 배포 및 모니터링](how-to-deploy-at-scale.md)에서 배포를 생성, 업데이트 또는 삭제하는 단계를 연습합니다.
* [IoT Edge 런타임](iot-edge-runtime.md) 및 [IoT Edge 모듈](iot-edge-modules.md)과 같은 다른 IoT Edge 개념에 대해 자세히 알아봅니다.
